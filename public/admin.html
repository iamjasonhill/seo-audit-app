<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Users</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#f5f7fa; color:#333; }
    .top { background:#fff; box-shadow:0 2px 4px rgba(0,0,0,.08); padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:5 }
    .container { max-width:1000px; margin:1.5rem auto; padding:0 1rem; }
    .card { background:#fff; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.08); padding:1rem; margin-bottom:1rem; }
    .audit-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border:none; border-radius:6px; padding:.5rem .75rem; cursor:pointer; display:inline-flex; align-items:center; gap:.4rem; }
    .history-table { width:100%; border-collapse:collapse; }
    .history-table th, .history-table td { padding:.6rem; text-align:left; border-bottom:1px solid #e1e5e9; }
    .muted { color:#666; font-size:.9rem }
    .error { color:#c33; margin:.5rem 0 }
    .success { color:#155724; margin:.5rem 0 }
    input, select { padding:.5rem; border:1px solid #e1e5e9; border-radius:6px }
  </style>
</head>
<body>
  <div class="top">
    <div style="font-weight:700"><i class="fas fa-user-shield"></i> Admin</div>
    <div>
      <a href="/dashboard" class="audit-btn" style="background:#6c757d"><i class="fas fa-arrow-left"></i> Dashboard</a>
    </div>
  </div>
  <div class="container">
    <div class="card">
      <h3 style="margin:.25rem 0 1rem 0"><i class="fas fa-users"></i> Users</h3>
      <div id="msg" class="muted"></div>
      <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.75rem">
        <input id="email" type="email" placeholder="user@example.com" style="min-width:260px">
        <select id="role"><option value="user">user</option><option value="admin">admin</option></select>
        <button id="addBtn" class="audit-btn"><i class="fas fa-plus"></i> Add / Activate</button>
        <button id="refreshBtn" class="audit-btn" style="background:#6c757d"><i class="fas fa-rotate"></i> Refresh</button>
      </div>
      <div id="users"></div>
    </div>

    <div class="card">
      <h3 style="margin:.25rem 0 1rem 0"><i class="fas fa-sitemap"></i> User → Domains</h3>
      <div id="userProps"></div>
    </div>
  </div>

  <script>
    async function api(path, opts={}){ const r=await fetch(path,{ credentials:'include', headers:{'Content-Type':'application/json'}, ...opts}); const d=await r.json().catch(()=>({})); if(!r.ok||!d.success) throw new Error(d.message||'Request failed'); return d; }
    const msg = document.getElementById('msg');
    function show(m,ok){ msg.textContent=m; msg.className = ok? 'success':'error'; setTimeout(()=>{ msg.textContent=''; msg.className='muted'; },4000); }
    async function load(){
      try{
        const d = await api('/api/admin/users');
        const rows = d.users||[];
        const table = `
          <table class="history-table">
            <thead><tr><th>ID</th><th>Email</th><th>Name</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>
              ${rows.map(u=>`<tr>
                <td>${u.id}</td>
                <td>${u.email}</td>
                <td>${u.name||''}</td>
                <td>
                  <select data-role="${u.id}"><option ${u.role==='user'?'selected':''}>user</option><option ${u.role==='admin'?'selected':''}>admin</option></select>
                </td>
                <td>
                  <select data-status="${u.id}"><option ${u.status==='active'?'selected':''}>active</option><option ${u.status==='disabled'?'selected':''}>disabled</option></select>
                </td>
                <td><button class="audit-btn" data-save="${u.id}" style="background:#198754"><i class="fas fa-save"></i> Save</button></td>
              </tr>`).join('')}
            </tbody>
          </table>`;
        document.getElementById('users').innerHTML = table;
        document.querySelectorAll('[data-save]').forEach(btn=>{
          btn.onclick = async ()=>{
            const id = btn.getAttribute('data-save');
            const role = document.querySelector(`[data-role="${id}"]`).value;
            const status = document.querySelector(`[data-status="${id}"]`).value;
            try{ await api(`/api/admin/users/${id}`, { method:'PATCH', body: JSON.stringify({ role, status }) }); show('Saved user '+id,true); }
            catch(e){ show(e.message,false); }
          };
        });
      }catch(e){ show(e.message,false); }
    }
    async function loadUserProps(){
      const host = document.getElementById('userProps');
      host.innerHTML = '<p class="muted"><i class="fas fa-spinner fa-spin"></i> Loading…</p>';
      try {
        const d = await api('/api/admin/user-properties');
        const items = d.items||[];
        if (!items.length) { host.innerHTML = '<p class="muted">No user properties registered.</p>'; return; }
        const rows = items.map(x=>{
          const props = (x.properties||[]).filter(p => String(p.siteUrl||'').startsWith('sc-domain:'));
          const list = props.map(p=>`<li>${p.siteUrl} ${p.enabled?'' : '<span class=\'muted\'>(disabled)</span>'}</li>`).join('');
          return `<tr>
            <td>${x.user.id}</td>
            <td>${x.user.email}</td>
            <td>${x.user.username||''}</td>
            <td>${x.user.role}</td>
            <td>${x.user.status}</td>
            <td>${props.length}</td>
            <td><ul style="margin-left:1rem">${list||'<li class=\'muted\'>—</li>'}</ul></td>
          </tr>`;
        }).join('');
        host.innerHTML = `
          <table class="history-table">
            <thead><tr><th>ID</th><th>Email</th><th>Username</th><th>Role</th><th>Status</th><th># Domains</th><th>Domains</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>`;
      } catch(e) {
        host.innerHTML = `<p class="error">${e.message}</p>`;
      }
    }
    document.getElementById('refreshBtn').onclick=load;
    document.getElementById('addBtn').onclick=async()=>{
      const email = document.getElementById('email').value.trim();
      const role = document.getElementById('role').value;
      if(!email){ show('Email required',false); return; }
      try{ await api('/api/admin/users',{ method:'POST', body: JSON.stringify({ email, role }) }); show('User added/activated',true); await load(); }
      catch(e){ show(e.message,false); }
    };
    (async ()=>{ await load(); await loadUserProps(); })();
  </script>
</body>
</html>


