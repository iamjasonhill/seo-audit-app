<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard - SEO Audit App</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .settings { margin-top: 2rem; }
        .settings .form { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .settings .form .full { grid-column: 1 / -1; }
        .settings .form input { padding: 0.6rem; border: 2px solid #e1e5e9; border-radius: 6px; }
        .settings .form button { margin-top: 0.5rem; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin-bottom: 1rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .audit-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .audit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .audit-btn:hover {
            transform: translateY(-2px);
        }

        .audit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .audit-history {
            grid-column: 1 / -1;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .history-table th,
        .history-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-good {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .prop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: .75rem; }
        .prop-tile { border: 1px solid #e1e5e9; border-radius: 8px; padding: .75rem 1rem; background:#fff; }
        .prop-title { font-weight:600; display:flex; align-items:center; gap:.5rem; }
        .prop-url { font-size:.9rem; margin:.25rem 0; }
        .prop-muted { color:#666; font-size:.85rem }
        .cov-badge { display:inline-block; padding:.15rem .45rem; border-radius:999px; font-size:.75rem; border:1px solid #e1e5e9; }
        .cov-ok { background:#e8f5e9; border-color:#c8e6c9; color:#2e7d32; }
        .cov-warn { background:#fff8e1; border-color:#ffe082; color:#8a6d3b; }
        .cov-miss { background:#fdecea; border-color:#f5c6cb; color:#a33; }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }

        .success-message {
            background: #efe;
            color: #363;
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }

        .view-audit-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.8rem;
        }

        .view-audit-btn:hover {
            background: #5a6fd8;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 1rem;
            }
            
            .container {
                padding: 0 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-chart-line"></i> SEO Audit Dashboard</h1>
        <div class="user-info">
            <a id="adminLink" href="/admin" class="logout-btn" style="background:#6c757d; display:none">
                <i class="fas fa-shield-alt"></i> Admin
            </a>
            <span id="userInfo">Loading...</span>
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <div class="container">
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="dashboard-grid">
            <div class="card">
                <h2><i class="fas fa-info-circle"></i> Quick Stats</h2>
                <div id="quickStats">
                    <p><strong>Total Audits:</strong> <span id="totalAudits">-</span></p>
                    <p><strong>Last Audit:</strong> <span id="lastAudit">-</span></p>
                    <p><strong>Most Audited Site:</strong> <span id="mostAudited">-</span></p>
                </div>
                <div style="margin-top:1rem; display:flex; gap:.5rem; align-items:center;">
                    <button id="connectGscBtn" class="audit-btn" style="width:auto"><i class="fab fa-google"></i> Connect Google Search Console</button>
                    <button id="listGscPropsBtn" class="audit-btn" style="width:auto; background:#6c757d"><i class="fas fa-list"></i> List Properties</button>
                </div>
                <div id="gscProperties" style="margin-top:.75rem"></div>
            </div>

            <div class="card">
                <h2><i class="fas fa-database"></i> Google Search Console Sync Registry</h2>
                <div style="margin:.25rem 0 .5rem 0">
                    <button id="syncRegRefresh" class="audit-btn" style="width:auto;background:#6c757d"><i class="fas fa-rotate"></i> Refresh</button>
                </div>
                <div id="syncRegistry"></div>
            </div>

            <div class="card">
                <h2><i class="fab fa-microsoft"></i> Bing Webmaster Tools Sync Registry</h2>
                <div style="margin:.25rem 0 .5rem 0; display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
                    <button id="bingSyncRefresh" class="audit-btn" style="width:auto;background:#6c757d"><i class="fas fa-rotate"></i> Refresh</button>
                    <button id="bingDiscoverBtn" class="audit-btn" style="width:auto;background:#0078d4"><i class="fas fa-search"></i> Discover Domains</button>
                    <button id="bingSchedulerTick" class="audit-btn" style="width:auto;background:#28a745"><i class="fas fa-play"></i> Manual Sync</button>
                    <button id="bingTestApiBtn" class="audit-btn" style="width:auto;background:#ffc107; color:#000"><i class="fas fa-bug"></i> Test API</button>
                </div>
                <div id="bingSyncRegistry"></div>
            </div>

            <div class="card">
                <h2><i class="fas fa-search"></i> New Audit</h2>
                <form id="auditForm" class="audit-form">
                    <div class="form-group">
                        <label for="siteUrl">Website URL</label>
                        <input type="url" id="siteUrl" name="siteUrl" placeholder="https://example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="siteType">Site Type</label>
                        <select id="siteType" name="siteType">
                            <option value="Generic">Generic</option>
                            <option value="SaaS">SaaS</option>
                            <option value="Ecommerce">Ecommerce</option>
                            <option value="Agency">Agency</option>
                            <option value="Local">Local</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="audit-btn" id="auditBtn">
                        <i class="fas fa-play"></i> Start Audit
                    </button>
                    <button type="button" class="audit-btn" id="quickTestBtn" style="background:#28a745">
                        <i class="fas fa-bolt"></i> Quick Test movingagain.com.au
                    </button>
                </form>
            </div>

            

            

            

            
        </div>

        <div class="card settings">
            <h2><i class="fas fa-user-cog"></i> Account Settings</h2>
            <div class="error-message" id="pwdError"></div>
            <div class="success-message" id="pwdSuccess"></div>
            <form id="changePasswordForm" class="form" autocomplete="off">
                <div style="position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;">
                    <input type="text" tabindex="-1" aria-hidden="true" autocomplete="username">
                    <input type="password" tabindex="-1" aria-hidden="true" autocomplete="current-password">
                </div>
                <div>
                    <label for="currentPassword">Current Password</label>
                    <div style="display:flex;gap:.5rem;align-items:center">
                        <input type="password" id="currentPassword" name="currentPassword" autocomplete="current-password" autocapitalize="none" autocorrect="off" spellcheck="false" required style="flex:1">
                        <input type="text" id="currentPasswordText" style="flex:1; display:none" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false">
                        <button type="button" class="view-toggle" data-target="currentPassword" title="Show/Hide" style="padding:.5rem 0.6rem;border:1px solid #e1e5e9;border-radius:6px;background:#fff"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                <div></div>
                <div>
                    <label for="newPassword">New Password</label>
                    <div style="display:flex;gap:.5rem;align-items:center">
                        <input type="password" id="newPassword" name="newPassword" autocomplete="new-password" autocapitalize="none" autocorrect="off" spellcheck="false" required placeholder="Min 12 chars, upper/lower/number/symbol" style="flex:1">
                        <input type="text" id="newPasswordText" style="flex:1; display:none" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" placeholder="Min 12 chars, upper/lower/number/symbol">
                        <button type="button" class="view-toggle" data-target="newPassword" title="Show/Hide" style="padding:.5rem 0.6rem;border:1px solid #e1e5e9;border-radius:6px;background:#fff"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                <div>
                    <label for="confirmPassword">Confirm New Password</label>
                    <div style="display:flex;gap:.5rem;align-items:center">
                        <input type="password" id="confirmPassword" name="confirmPassword" autocomplete="new-password" autocapitalize="none" autocorrect="off" spellcheck="false" required style="flex:1">
                        <input type="text" id="confirmPasswordText" style="flex:1; display:none" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false">
                        <button type="button" class="view-toggle" data-target="confirmPassword" title="Show/Hide" style="padding:.5rem 0.6rem;border:1px solid #e1e5e9;border-radius:6px;background:#fff"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                <div class="full">
                    <button type="submit" class="audit-btn" id="changePwdBtn" style="width:auto"><i class="fas fa-key"></i> Change Password</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class DashboardApp {
            constructor() {
                this.auditForm = document.getElementById('auditForm');
                this.auditBtn = document.getElementById('auditBtn');
                this.quickTestBtn = document.getElementById('quickTestBtn');
                this.logoutBtn = document.getElementById('logoutBtn');
                this.userInfo = document.getElementById('userInfo');
                this.errorMessage = document.getElementById('errorMessage');
                this.successMessage = document.getElementById('successMessage');
                this.auditHistory = document.getElementById('auditHistory');
                this.changePasswordForm = document.getElementById('changePasswordForm');
                this.changePwdBtn = document.getElementById('changePwdBtn');
                this.pwdError = document.getElementById('pwdError');
                this.pwdSuccess = document.getElementById('pwdSuccess');
                document.querySelectorAll('.view-toggle').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-target');
                        const pwd = document.getElementById(id);
                        const txt = document.getElementById(id + 'Text');
                        const showing = txt && txt.style.display !== 'none';
                        if (!txt) {
                            // Fallback for browsers that support toggling natively
                            const isPlain = pwd.type === 'text';
                            pwd.type = isPlain ? 'password' : 'text';
                            btn.innerHTML = isPlain ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
                            return;
                        }
                        if (showing) {
                            // Switch to password field
                            pwd.value = txt.value;
                            txt.style.display = 'none';
                            pwd.style.display = '';
                            btn.innerHTML = '<i class="fas fa-eye"></i>';
                        } else {
                            // Switch to text field (Safari-friendly)
                            txt.value = pwd.value;
                            pwd.style.display = 'none';
                            txt.style.display = '';
                            btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                        }
                    });
                });
                
                this.auditForm.addEventListener('submit', this.handleAuditSubmit.bind(this));
                this.quickTestBtn.addEventListener('click', this.handleQuickTest.bind(this));
                this.logoutBtn.addEventListener('click', this.handleLogout.bind(this));
                this.changePasswordForm.addEventListener('submit', this.handleChangePassword.bind(this));
                this.initUrlInspection();
                this.initInsights();
                this.initSitemaps(); // Initialize sitemaps
                
                this.init();
                this.loadSyncRegistry();
                this.initBingSyncRegistry();

                // Clear any autofilled values shortly after load
                setTimeout(() => {
                    const ids = ['currentPassword','newPassword','confirmPassword'];
                    ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                }, 60);
            }

            initUrlInspection() {
                const btn = document.getElementById('inspectBtn');
                const input = document.getElementById('inspectUrl');
                const out = document.getElementById('inspectResult');
                if (!btn || !input || !out) return;
                btn.addEventListener('click', async () => {
                    const url = (input.value || '').trim();
                    if (!url) { this.showError('Enter a URL to inspect'); return; }
                    const original = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Inspecting...';
                    out.innerHTML = '';
                    try {
                        const resp = await fetch('/api/gsc/url/inspect', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ url })
                        });
                        const data = await resp.json();
                        if (!resp.ok || !data.success) throw new Error(data.message || 'Inspection failed');
                        const r = data.result || {};
                        const idx = r.indexStatusResult || {};
                        const mobi = r.mobileUsabilityResult || {};
                        const amp = r.ampResult || {};
                        out.innerHTML = `
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:.5rem">
                                <div class="card" style="padding:.75rem 1rem">
                                    <div style="font-weight:600;margin-bottom:.25rem">Index Status</div>
                                    <div><strong>Verdict:</strong> ${idx.verdict || 'Unknown'}</div>
                                    <div><strong>Coverage State:</strong> ${idx.coverageState || 'Unknown'}</div>
                                    <div><strong>Last Crawl:</strong> ${idx.lastCrawlTime || '—'}</div>
                                    <div><strong>Robots:</strong> ${idx.robotsTxtState || 'Unknown'}</div>
                                    <div><strong>Noindex:</strong> ${idx.indexingState || 'Unknown'}</div>
                                    <div><strong>User Canonical:</strong> ${idx.userCanonical || '—'}</div>
                                    <div><strong>Google Canonical:</strong> ${idx.googleCanonical || '—'}</div>
                                </div>
                                <div class="card" style="padding:.75rem 1rem">
                                    <div style="font-weight:600;margin-bottom:.25rem">Mobile Usability</div>
                                    <div><strong>Status:</strong> ${mobi.verdict || 'Unknown'}</div>
                                    <div><strong>Issues:</strong> ${(mobi.issues && mobi.issues.length) ? mobi.issues.map(i=>i.message).join(', ') : 'None reported'}</div>
                                    <div style="font-weight:600;margin:.75rem 0 .25rem">AMP</div>
                                    <div><strong>Status:</strong> ${amp.verdict || 'Unknown'}</div>
                                </div>
                            </div>
                        `;
                    } catch (err) {
                        out.innerHTML = `<p style=\"color:#c33\">${err.message}</p>`;
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = original;
                    }
                });
            }

            initInsights() {
                const pagesBtn = document.getElementById('loadPagesBtn');
                const queriesBtn = document.getElementById('loadQueriesBtn');
                const deviceBtn = document.getElementById('loadDeviceBtn');
                const countryBtn = document.getElementById('loadCountryBtn');
                const appearanceBtn = document.getElementById('loadAppearanceBtn');
                const out = document.getElementById('gscInsights');
                const startInput = document.getElementById('gscStart');
                const endInput = document.getElementById('gscEnd');
                const applyBtn = document.getElementById('applyRangeBtn');
                const pager = document.getElementById('gscPager');
                const typeSelect = document.getElementById('gscType');
                let currentEndpoint = '/api/gsc/analytics/pages';
                let currentType = 'pages';
                let rowLimit = 50;
                let startRow = 0;
                const rowsSelect = document.getElementById('gscRows');
                if (rowsSelect) rowsSelect.addEventListener('change', () => {
                    rowLimit = parseInt(rowsSelect.value || '50', 10);
                    startRow = 0;
                    // reload current view
                    load(currentEndpoint, currentType);
                });
                const renderRows = (rows, type) => {
                    if (!rows || rows.length === 0) {
                        out.innerHTML = '<p>No data for selected range.</p>';
                        pager.innerHTML = '';
                        return;
                    }
                    const colLabel = (
                        type === 'pages' ? 'Page' :
                        type === 'queries' ? 'Query' :
                        type === 'device' ? 'Device' :
                        type === 'country' ? 'Country' :
                        type === 'appearance' ? 'Appearance' : 'Item'
                    );
                    const head = `<th>${colLabel}</th>`;
                    const firstVal = (r) => (
                        type === 'pages' ? (r.page || '') :
                        type === 'queries' ? (r.query || '') :
                        type === 'device' ? (r.device || '') :
                        type === 'country' ? (r.country || '') :
                        type === 'appearance' ? (r.appearance || '') : ''
                    );
                    const body = rows.map(r => `
                        <tr>
                            <td>${firstVal(r)}</td>
                            <td>${(r.clicks||0).toLocaleString()}</td>
                            <td>${(r.impressions||0).toLocaleString()}</td>
                            <td>${(((r.ctr||0)*100)||0).toFixed(2)}%</td>
                            <td>${((r.position||0)||0).toFixed(1)}</td>
                        </tr>`).join('');
                    out.innerHTML = `
                        <table class="history-table">
                            <thead><tr>${head}<th>Clicks</th><th>Impressions</th><th>CTR</th><th>Pos</th></tr></thead>
                            <tbody>${body}</tbody>
                        </table>
                    `;
                    // Pager UI
                    pager.innerHTML = `
                        <button id="pgPrev" class="audit-btn" style="width:auto;background:#6c757d" ${startRow===0?'disabled':''}><i class="fas fa-chevron-left"></i> Prev</button>
                        <span style="font-size:.9rem;color:#555">Rows ${startRow+1}–${startRow+rows.length}</span>
                        <button id="pgNext" class="audit-btn" style="width:auto"><i class="fas fa-chevron-right"></i> Next</button>
                    `;
                    const nextBtn = document.getElementById('pgNext');
                    const prevBtn = document.getElementById('pgPrev');
                    if (prevBtn) prevBtn.onclick = () => { if (startRow>0){ startRow = Math.max(0, startRow - rowLimit); load(currentEndpoint, currentType); } };
                    if (nextBtn) nextBtn.onclick = () => { startRow += rowLimit; load(currentEndpoint, currentType); };
                };
                const buildUrl = (endpoint) => {
                    const params = new URLSearchParams();
                    if (startInput && startInput.value) params.append('startDate', startInput.value);
                    if (endInput && endInput.value) params.append('endDate', endInput.value);
                    if (typeSelect && typeSelect.value) params.append('searchType', typeSelect.value);
                    params.append('rowLimit', String(rowLimit));
                    params.append('startRow', String(startRow));
                    return `${endpoint}?${params.toString()}`;
                };
                const load = async (endpoint, type) => {
                    currentEndpoint = endpoint; currentType = type;
                    out.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading...</p>';
                    try {
                        const resp = await fetch(buildUrl(endpoint), { credentials: 'include' });
                        const data = await resp.json();
                        if (!resp.ok || !data.success) throw new Error(data.message || 'Failed to load');
                        renderRows(data.data, type);
                    } catch (err) {
                        out.innerHTML = `<p style=\"color:#c33\">${err.message}</p>`;
                        pager.innerHTML = '';
                    }
                };
                // default last 28d
                const now = new Date();
                const start = new Date(now.getTime() - 27*24*60*60*1000);
                const fmt = (d) => {
                    if (d instanceof Date) return d.toISOString().slice(0,10);
                    const dd = new Date(d);
                    if (!isNaN(dd.getTime())) return dd.toISOString().slice(0,10);
                    return new Date().toISOString().slice(0,10);
                };
                if (startInput) startInput.value = fmt(start);
                if (endInput) endInput.value = fmt(now);
                if (applyBtn) applyBtn.addEventListener('click', () => {
                    startRow = 0; // reset paging
                    const activeMap = [
                        { btn: pagesBtn, ep: '/api/gsc/analytics/pages', type: 'pages' },
                        { btn: queriesBtn, ep: '/api/gsc/analytics/queries', type: 'queries' },
                        { btn: deviceBtn, ep: '/api/gsc/analytics/device', type: 'device' },
                        { btn: countryBtn, ep: '/api/gsc/analytics/country', type: 'country' },
                        { btn: appearanceBtn, ep: '/api/gsc/analytics/appearance', type: 'appearance' },
                    ];
                    const active = activeMap.find(x => x.btn && x.btn.dataset.active === '1') || activeMap[0];
                    load(active.ep, active.type);
                });
                const setActive = (btn) => {
                    [pagesBtn, queriesBtn, deviceBtn, countryBtn, appearanceBtn].forEach(b => { if (b) b.dataset.active = (b===btn?'1':'0'); });
                };
                if (pagesBtn) pagesBtn.addEventListener('click', () => { setActive(pagesBtn); startRow = 0; load('/api/gsc/analytics/pages', 'pages'); });
                if (queriesBtn) queriesBtn.addEventListener('click', () => { setActive(queriesBtn); startRow = 0; load('/api/gsc/analytics/queries', 'queries'); });
                if (deviceBtn) deviceBtn.addEventListener('click', () => { setActive(deviceBtn); startRow = 0; load('/api/gsc/analytics/device', 'device'); });
                if (countryBtn) countryBtn.addEventListener('click', () => { setActive(countryBtn); startRow = 0; load('/api/gsc/analytics/country', 'country'); });
                if (appearanceBtn) appearanceBtn.addEventListener('click', () => { setActive(appearanceBtn); startRow = 0; load('/api/gsc/analytics/appearance', 'appearance'); });
            }

            async loadSyncRegistry() {
                const host = document.getElementById('syncRegistry');
                if (!host) return;
                host.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading registry…</p>';
                try {
                    const resp = await fetch('/api/gsc/sync/properties', { credentials:'include' });
                    const data = await resp.json();
                    if (!resp.ok || !data.success) throw new Error(data.message || 'Failed to load');
                    const isAdmin = !!data.isAdmin;
                    const rows = (data.properties||[])
                        .filter(r => String(r.siteUrl||'').startsWith('sc-domain:'))
                        .sort((a,b)=> (a.priorityOrder||0)-(b.priorityOrder||0));
                    if (!rows.length) { host.innerHTML = '<p>No properties registered yet. Click “List Properties” above to register all.</p>'; return; }
                    const fmt = (d)=> d ? new Date(d).toLocaleString(undefined,{dateStyle:'short',timeStyle:'short'}) : '—';
                    const link = (site, userId)=> site.startsWith('sc-domain:') ? `/property?site=${encodeURIComponent(site)}${isAdmin&&userId?`&userId=${encodeURIComponent(userId)}`:''}` : `/property?site=${encodeURIComponent(site)}${isAdmin&&userId?`&userId=${encodeURIComponent(userId)}`:''}`;
                    const table = `
                        <table class="history-table">
                          <thead><tr><th>#</th><th>Property</th>${isAdmin?'<th>User</th>':''}<th>Enabled</th><th>Last Full Sync</th><th>Next Due</th><th>Actions</th></tr></thead>
                          <tbody>
                          ${rows.map(r=>`
                            <tr>
                              <td>${r.priorityOrder ?? 0}</td>
                              <td><a class="view-audit-btn" href="${link(r.siteUrl, r.userId)}" target="_blank">${r.siteUrl}</a></td>
                              ${isAdmin?`<td>${r.owner?.email || r.owner?.username || r.userId || ''}</td>`:''}
                              <td>${r.enabled ? 'Yes' : 'No'}</td>
                              <td>${fmt(r.lastFullSyncAt)}</td>
                              <td>${fmt(r.nextSyncDueAt)}</td>
                              <td>
                                <button class="audit-btn" data-sync-now="${encodeURIComponent(r.siteUrl)}" style="width:auto;background:#198754"><i class="fas fa-forward"></i> Sync now</button>
                              </td>
                            </tr>`).join('')}
                          </tbody>
                        </table>
                    `;
                    host.innerHTML = table;
                    host.querySelectorAll('[data-sync-now]').forEach(btn => {
                        btn.addEventListener('click', async (e)=>{
                            const siteUrl = decodeURIComponent(btn.getAttribute('data-sync-now')||'');
                            btn.disabled = true; const orig = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Queuing…';
                            try {
                                const payload = { siteUrl, enabled:true };
                                // If admin clicked a row that has owner info, target that user
                                const row = rows.find(x => x.siteUrl === siteUrl);
                                if (isAdmin && row && row.userId) payload.userId = row.userId;
                                const r = await fetch('/api/gsc/sync/register', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload) });
                                const d = await r.json(); if (!r.ok || !d.success) throw new Error(d.message||'Failed');
                                await this.loadSyncRegistry();
                                this.showSuccess('Queued sync for '+siteUrl);
                            } catch(err) { this.showError(err.message); }
                            finally { btn.disabled=false; btn.innerHTML = orig; }
                        });
                    });
                } catch (err) {
                    host.innerHTML = `<p style=\"color:#c33\">${err.message}</p>`;
                }
                const refresh = document.getElementById('syncRegRefresh');
                if (refresh) refresh.onclick = ()=> this.loadSyncRegistry();
            }

            // Sitemaps panel
            initSitemaps() {
                const listDiv = document.getElementById('sitemapsList');
                const submitBtn = document.getElementById('submitSitemapBtn');
                const input = document.getElementById('sitemapUrl');
                
                // Only initialize if the sitemaps elements exist
                if (!listDiv) {
                    return; // Sitemaps panel not present on this page
                }
                
                const render = (items) => {
                    if (!items || items.length === 0) {
                        listDiv.innerHTML = '<p>No sitemaps found for this property.</p>';
                        return;
                    }
                    const rows = items.map(s => `
                        <tr>
                            <td>${s.path}</td>
                            <td>${s.isIndex ? 'Index' : 'File'}</td>
                            <td>${s.lastSubmitted || '—'}</td>
                            <td>${s.lastDownloaded || '—'}</td>
                            <td>${s.warnings||0}</td>
                            <td>${s.errors||0}</td>
                        </tr>`).join('');
                    listDiv.innerHTML = `
                        <table class="history-table">
                            <thead><tr><th>Path</th><th>Type</th><th>Last Submitted</th><th>Last Downloaded</th><th>Warnings</th><th>Errors</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    `;
                };
                const load = async () => {
                    listDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading...</p>';
                    try {
                        const resp = await fetch('/api/gsc/sitemaps', { credentials: 'include' });
                        const data = await resp.json();
                        if (!resp.ok || !data.success) throw new Error(data.message || 'Failed to load sitemaps');
                        render(data.sitemaps);
                    } catch (err) {
                        listDiv.innerHTML = `<p style=\"color:#c33\">${err.message}</p>`;
                    }
                };
                if (submitBtn) submitBtn.addEventListener('click', async () => {
                    const url = (input.value||'').trim();
                    if (!url) { this.showError('Enter a sitemap URL to submit'); return; }
                    const orig = submitBtn.innerHTML; submitBtn.disabled = true; submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting';
                    try {
                        const resp = await fetch('/api/gsc/sitemaps/submit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ sitemapUrl: url })
                        });
                        const data = await resp.json();
                        if (!resp.ok || !data.success) throw new Error(data.message || 'Submit failed');
                        this.showSuccess('Sitemap submitted');
                        await load();
                    } catch (err) {
                        this.showError(err.message);
                    } finally {
                        submitBtn.disabled = false; submitBtn.innerHTML = orig;
                    }
                });
                load();
            }

            async init() {
                await this.checkAuthStatus();
                await this.loadQuickStats();
                this.initGsc();
            }

            async checkAuthStatus() {
                try {
                    const response = await fetch('/api/auth/status', {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    
                    if (!data.authenticated) {
                        window.location.href = '/login';
                        return;
                    }
                    
                    this.userInfo.textContent = `Welcome, ${data.user.email || data.user.username}`;
                    // Toggle Admin link for admin role
                    try {
                        const adminLink = document.getElementById('adminLink');
                        if (adminLink) adminLink.style.display = (data.user?.role === 'admin') ? 'inline-flex' : 'none';
                    } catch (_) {}
                } catch (error) {
                    window.location.href = '/login';
                }
            }

            async handleAuditSubmit(e) {
                e.preventDefault();
                
                const siteUrl = document.getElementById('siteUrl').value;
                const siteType = document.getElementById('siteType').value;
                
                this.auditBtn.disabled = true;
                this.auditBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running Audit...';
                this.hideMessages();
                
                try {
                    const response = await fetch('/api/audit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify({ siteUrl, siteType })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.showSuccess(`Audit completed for ${siteUrl}`);
                        this.loadAuditHistory();
                        this.loadQuickStats();
                        this.auditForm.reset();
                    } else {
                        this.showError(data.message || 'Audit failed');
                    }
                } catch (error) {
                    this.showError('Network error. Please try again.');
                } finally {
                    this.auditBtn.disabled = false;
                    this.auditBtn.innerHTML = '<i class="fas fa-play"></i> Start Audit';
                }
            }

            async handleQuickTest() {
                const siteUrl = 'https://movingagain.com.au';
                const siteType = 'Generic';
                this.hideMessages();

                const original = this.quickTestBtn.innerHTML;
                this.quickTestBtn.disabled = true;
                this.quickTestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';

                try {
                    const response = await fetch('/api/audit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ siteUrl, siteType })
                    });
                    const data = await response.json();
                    if (data.success) {
                        this.showSuccess(`Quick test completed for ${siteUrl}`);
                        await this.loadAuditHistory();
                        await this.loadQuickStats();
                    } else {
                        this.showError(data.message || 'Quick test failed');
                    }
                } catch (err) {
                    this.showError('Network error. Please try again.');
                } finally {
                    this.quickTestBtn.disabled = false;
                    this.quickTestBtn.innerHTML = original;
                }
            }

            async loadAuditHistory() {
                try {
                    const response = await fetch('/api/audit/list?limit=25', {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        this.displayAuditHistory(data.audits);
                    } else {
                        this.auditHistory.innerHTML = '<p>Failed to load audit history</p>';
                    }
                } catch (error) {
                    this.auditHistory.innerHTML = '<p>Error loading audit history</p>';
                }
            }

            displayAuditHistory(audits) {
                if (audits.length === 0) {
                    this.auditHistory.innerHTML = '<p>No audits found. Run your first audit above!</p>';
                    return;
                }

                const table = `
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th style="width:32px"><input type="checkbox" id="selectAllAudits"></th>
                                <th>Site URL</th>
                                <th>Type</th>
                                <th>Date &amp; Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${audits.map(audit => `
                                <tr>
                                    <td><input type="checkbox" class="audit-select" data-audit-id="${audit.id}"></td>
                                    <td>${audit.siteUrl}</td>
                                    <td>${audit.siteType}</td>
                                    <td>${new Date(audit.createdAt).toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' })}</td>
                                    <td>
                                        <span class="status-badge ${audit.hasResults ? 'status-good' : 'status-warning'}">
                                            ${audit.hasResults ? 'Complete' : 'Pending'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="/report.html?auditId=${audit.id}" class="view-audit-btn" target="_blank">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                            <button class="delete-btn" data-audit-id="${audit.id}">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top:.75rem; display:flex; gap:.5rem; align-items:center">
                        <button class="delete-btn" id="deleteSelectedBtn" style="background:#b22222"><i class="fas fa-trash"></i> Delete Selected</button>
                        <span id="selectedCount" style="font-size:.9rem; color:#555"></span>
                    </div>
                `;

                this.auditHistory.innerHTML = table;

                this.auditHistory.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        if (button.id === 'deleteSelectedBtn') {
                            this.handleBulkDelete(button);
                        } else {
                            this.handleDeleteAudit(button.dataset.auditId, button);
                        }
                    });
                });

                // Select-all and selection count
                const selectAll = document.getElementById('selectAllAudits');
                const checkboxes = Array.from(this.auditHistory.querySelectorAll('.audit-select'));
                const selectedCount = document.getElementById('selectedCount');
                const updateCount = () => {
                    const count = checkboxes.filter(cb => cb.checked).length;
                    selectedCount.textContent = count ? `${count} selected` : '';
                };
                if (selectAll) {
                    selectAll.addEventListener('change', () => {
                        checkboxes.forEach(cb => cb.checked = selectAll.checked);
                        updateCount();
                    });
                }
                checkboxes.forEach(cb => cb.addEventListener('change', () => {
                    if (!cb.checked && selectAll) selectAll.checked = false;
                    updateCount();
                }));
            }

            async handleDeleteAudit(auditId, button) {
                const confirmed = confirm('Are you sure you want to delete this audit? This action cannot be undone.');
                if (!confirmed) {
                    return;
                }

                const originalContent = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting';

                this.hideMessages();

                try {
                    const response = await fetch(`/api/audit/${auditId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (!response.ok || !data.success) {
                        throw new Error(data.message || 'Failed to delete audit.');
                    }

                    this.showSuccess('Audit deleted successfully.');
                    await this.loadAuditHistory();
                    await this.loadQuickStats();
                } catch (error) {
                    this.showError(error.message || 'Failed to delete audit. Please try again.');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            }

            async handleBulkDelete(button) {
                const ids = Array.from(this.auditHistory.querySelectorAll('.audit-select:checked')).map(cb => cb.dataset.auditId);
                if (ids.length === 0) {
                    alert('Please select at least one audit to delete.');
                    return;
                }
                const confirmed = confirm(`Delete ${ids.length} audit(s)? This cannot be undone.`);
                if (!confirmed) return;

                const original = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting';
                try {
                    for (const id of ids) {
                        const res = await fetch(`/api/audit/${id}`, { method: 'DELETE', credentials: 'include' });
                        const data = await res.json();
                        if (!res.ok || !data.success) throw new Error(data.message || 'Delete failed');
                    }
                    this.showSuccess(`${ids.length} audit(s) deleted.`);
                    await this.loadAuditHistory();
                    await this.loadQuickStats();
                } catch (err) {
                    this.showError(err.message || 'Bulk delete failed.');
                } finally {
                    button.disabled = false;
                    button.innerHTML = original;
                }
            }

            async loadQuickStats() {
                try {
                    const response = await fetch('/api/audit/list?limit=100', {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        const audits = data.audits;
                        const totalAudits = audits.length;
                        const lastAudit = audits.length > 0
                            ? new Date(audits[0].createdAt).toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' })
                            : 'None';
                        
                        // Find most audited site
                        const siteCounts = {};
                        audits.forEach(audit => {
                            siteCounts[audit.siteUrl] = (siteCounts[audit.siteUrl] || 0) + 1;
                        });
                        const mostAudited = Object.keys(siteCounts).reduce((a, b) => 
                            siteCounts[a] > siteCounts[b] ? a : b, 'None'
                        );
                        
                        document.getElementById('totalAudits').textContent = totalAudits;
                        document.getElementById('lastAudit').textContent = lastAudit;
                        document.getElementById('mostAudited').textContent = mostAudited;
                    }
                } catch (error) {
                    console.error('Error loading quick stats:', error);
                }
            }

            initGsc() {
                const connectBtn = document.getElementById('connectGscBtn');
                const listBtn = document.getElementById('listGscPropsBtn');
                const propsDiv = document.getElementById('gscProperties');

                // Helpers to persist and render saved properties (alphabetical)
                const sortProps = (arr=[]) => arr.slice().sort((a,b)=> String(a.siteUrl||'').localeCompare(String(b.siteUrl||''), undefined, { sensitivity:'base' }));
                const getSavedProps = () => {
                    try { return sortProps(JSON.parse(localStorage.getItem('gscProps')||'[]')); } catch(_) { return []; }
                };
                const saveProps = (props=[]) => { try { localStorage.setItem('gscProps', JSON.stringify(sortProps(props))); } catch(_){} };
                const ensurePropsShell = () => {
                    if (!propsDiv) return;
                    if (!propsDiv.dataset.prepared) {
                        propsDiv.innerHTML = `
                            <div id="propsSelectorWrap"></div>
                            <div style="margin-top:.75rem">
                                <div style="font-weight:600;margin-bottom:.25rem">Saved Properties</div>
                                <div id="savedProps"></div>
                            </div>`;
                        propsDiv.dataset.prepared = '1';
                    }
                };
                const renderSavedProps = async (props) => {
                    ensurePropsShell();
                    const list = document.getElementById('savedProps');
                    if (!list) return;
                    const items = (props && props.length ? props : getSavedProps());
                    if (!items.length) { list.innerHTML = '<p>No properties saved yet. Connect and list properties to populate.</p>'; return; }

                    // Group by sc-domain vs url-prefix, and hide URL-prefix when domain exists
                    const groups = { domain: {}, url: [] };
                    const getDomainKey = (url) => {
                        if (!url) return null;
                        if (url.startsWith('sc-domain:')) return url.replace('sc-domain:','').toLowerCase();
                        try { const u = new URL(url); return u.hostname.toLowerCase(); } catch (_) { return null; }
                    };
                    const domainSet = new Set(items.filter(p=> (p.siteUrl||'').startsWith('sc-domain:')).map(p=> getDomainKey(p.siteUrl)));
                    items.forEach(p => {
                        const s = p.siteUrl || '';
                        if (s.startsWith('sc-domain:')) {
                            const k = getDomainKey(s); if (!k) return;
                            if (!groups.domain[k]) groups.domain[k] = { scDomain: s, urls: [] };
                        } else {
                            const k = getDomainKey(s);
                            // If an sc-domain exists for this hostname, treat URL-prefix as subordinate (hidden by default)
                            const suppressed = domainSet.has(k);
                            groups.url.push({ url: s, host: k, suppressed });
                        }
                    });

                    // Helper to fetch coverage for a site/type
                    async function getCoverage(siteUrl, type){
                        try {
                            const r = await fetch(`/api/gsc/coverage?siteUrl=${encodeURIComponent(siteUrl)}&searchType=${encodeURIComponent(type)}`, { credentials:'include' });
                            const d = await r.json();
                            return (r.ok && d.success) ? (d.coverage || null) : null;
                        } catch(_) { return null; }
                    }

                    // Build tiles: domains first, then any hosts without sc-domain
                    const tiles = [];
                    const renderUrlList = (hostKey) => {
                        const urls = groups.url.filter(x => x.host === hostKey).map(x => x.url);
                        if (urls.length === 0) return '';
                        const id = `urls_${hostKey.replace(/[^a-z0-9]/gi,'_')}`;
                        return `
                          <div class="prop-muted" style="margin-top:.35rem">
                            <a href="#" data-toggle="${id}"><i class="fas fa-list"></i> Show URL-prefix properties (${urls.length})</a>
                          </div>
                          <ul id="${id}" style="display:none;margin:.35rem 0 0 .5rem">${urls.map(u=>`<li><a href="/property?site=${encodeURIComponent(u)}" target="_blank">${u}</a></li>`).join('')}</ul>
                        `;
                    };

                    // Domain tiles with coverage summary
                    for (const host of Object.keys(groups.domain).sort()) {
                        const scd = groups.domain[host].scDomain;
                        const types = ['web','image','video'];
                        const covs = await Promise.all(types.map(t => getCoverage(scd, t)));
                        const present = covs.filter(c => c && c.start && c.end);
                        const minStart = present.length ? present.map(c=>c.start).sort()[0] : null;
                        const maxEnd = present.length ? present.map(c=>c.end).sort().slice(-1)[0] : null;
                        const badgeClass = present.length === 0 ? 'cov-miss' : (present.length === types.length ? 'cov-ok' : 'cov-warn');
                        tiles.push(`
                          <div class="prop-tile">
                            <div class="prop-title"><i class="fas fa-globe"></i> sc-domain:${host}</div>
                            <div class="prop-muted" style="margin:.25rem 0">Saved data <span class="cov-badge ${badgeClass}">${(minStart && maxEnd) ? `${minStart} → ${maxEnd}` : '—'}</span></div>
                            <div class="prop-url"><a href="/property?site=${encodeURIComponent(scd)}" class="view-audit-btn" target="_blank">Open domain property</a></div>
                            ${renderUrlList(host)}
                          </div>
                        `);
                    }

                    // Hosts without sc-domain (show each URL as a tile)
                    const orphanHosts = groups.url.filter(x => !domainSet.has(x.host));
                    orphanHosts.sort((a,b)=> String(a.url).localeCompare(String(b.url)));
                    for (const x of orphanHosts) {
                        const cov = await getCoverage(x.url, 'web');
                        const have = !!(cov && cov.start && cov.end);
                        const badgeClass = have ? 'cov-ok' : 'cov-miss';
                        tiles.push(`
                          <div class="prop-tile">
                            <div class="prop-title"><i class="fas fa-link"></i> URL property</div>
                            <div class="prop-muted" style="margin:.25rem 0">Saved data <span class="cov-badge ${badgeClass}">${have ? `${cov.start} → ${cov.end}` : '—'}</span></div>
                            <div class="prop-url"><a href="/property?site=${encodeURIComponent(x.url)}" class="view-audit-btn" target="_blank">${x.url}</a></div>
                          </div>
                        `);
                    }

                    list.innerHTML = `<div class="prop-grid">${tiles.join('')}</div>`;
                    // Bind toggles
                    list.querySelectorAll('[data-toggle]').forEach(a => {
                        a.addEventListener('click', (e)=>{
                            e.preventDefault();
                            const id = a.getAttribute('data-toggle');
                            const el = document.getElementById(id); if (!el) return;
                            const showing = el.style.display !== 'none';
                            el.style.display = showing ? 'none' : '';
                            a.innerHTML = showing ? '<i class="fas fa-list"></i> Show URL-prefix properties' : '<i class="fas fa-list"></i> Hide URL-prefix properties';
                        });
                    });
                };
                // Render any previously saved list immediately
                renderSavedProps();

                if (connectBtn) {
                    connectBtn.addEventListener('click', async () => {
                        connectBtn.disabled = true;
                        connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
                        try {
                            const resp = await fetch('/api/gsc/connect', { credentials: 'include' });
                            const data = await resp.json();
                            if (!resp.ok || !data.success) throw new Error(data.message || 'Failed to init OAuth');
                            window.location.href = data.authUrl;
                        } catch (err) {
                            this.showError(err.message || 'Failed to connect to Google');
                            connectBtn.disabled = false;
                            connectBtn.innerHTML = '<i class="fab fa-google"></i> Connect Google Search Console';
                        }
                    });
                }

                // Try to bind tokens if we just returned from OAuth
                (async () => {
                    try {
                        const resp = await fetch('/api/gsc/bind', { method: 'POST', credentials: 'include' });
                        // ignore result; if tokens existed they'll be bound
                    } catch (e) { /* noop */ }
                })();

                if (listBtn) {
                    listBtn.addEventListener('click', async () => {
                        listBtn.disabled = true;
                        const original = listBtn.innerHTML;
                        listBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading';
                        try {
                            // Load current selection
                            let selectedSite = null;
                            try {
                                const selResp = await fetch('/api/gsc/selected', { credentials: 'include' });
                                const selData = await selResp.json();
                                if (selResp.ok && selData.success) selectedSite = selData.selected || null;
                            } catch (e) {}

                            const resp = await fetch('/api/gsc/properties', { credentials: 'include' });
                            const data = await resp.json();
                            if (!resp.ok || !data.success) throw new Error(data.message || 'Failed to load properties');
                            const properties = sortProps(data.properties || []);
                            if (!properties || properties.length === 0) {
                                ensurePropsShell();
                                const wrap = document.getElementById('propsSelectorWrap');
                                if (wrap) wrap.innerHTML = '<p>No verified properties found for this account.</p>';
                            } else {
                                saveProps(properties);
                                ensurePropsShell();
                                const selectorId = 'gscPropertySelect';
                                const options = properties.map(p => `<option value="${p.siteUrl}">${p.siteUrl}</option>`).join('');
                                const wrap = document.getElementById('propsSelectorWrap');
                                if (wrap) wrap.innerHTML = `
                                    <div style="margin:.5rem 0">
                                        <label for="${selectorId}" style="display:block;margin-bottom:.25rem;font-weight:500">Active Property</label>
                                        <select id="${selectorId}" style="padding:.5rem;border:1px solid #e1e5e9;border-radius:6px;min-width:320px">${options}</select>
                                        <button id="saveGscSelection" class="audit-btn" style="width:auto;margin-left:.5rem"><i class="fas fa-save"></i> Save</button>
                                        <a id="openProperty" class="audit-btn" style="width:auto;margin-left:.5rem;background:#198754" target="_blank"><i class="fas fa-arrow-up-right-from-square"></i> Open</a>
                                    </div>
                                    <div id="gscKpis" style="margin-top:.5rem"></div>`;
                                // Preselect
                                const sel = document.getElementById(selectorId);
                                if (selectedSite) sel.value = selectedSite;
                                const openBtn = document.getElementById('openProperty');
                                const setOpenHref = () => { openBtn.href = `/property?site=${encodeURIComponent(sel.value)}`; };
                                setOpenHref();
                                sel.addEventListener('change', setOpenHref);
                                document.getElementById('saveGscSelection').addEventListener('click', async () => {
                                    const siteUrl = sel.value;
                                    const btn = document.getElementById('saveGscSelection');
                                    const orig = btn.innerHTML;
                                    btn.disabled = true;
                                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving';
                                    try {
                                        const resp = await fetch('/api/gsc/selected', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            credentials: 'include',
                                            body: JSON.stringify({ siteUrl })
                                        });
                                        const data = await resp.json();
                                        if (!resp.ok || !data.success) throw new Error(data.message || 'Failed to set property');
                                        this.showSuccess('Active property saved');
                                        await this.loadGscKpis();
                                        // Reload sitemaps panel for the selected property
                                        if (this.initSitemaps) this.initSitemaps();
                                    } catch (err) {
                                        this.showError(err.message);
                                    } finally {
                                        btn.disabled = false;
                                        btn.innerHTML = orig;
                                    }
                                });
                                // Load KPIs if selection exists
                                await this.loadGscKpis();
                                // Update saved properties list
                                renderSavedProps(properties);
                            }
                        } catch (err) {
                            propsDiv.innerHTML = `<p style=\"color:#c33\">${err.message}</p>`;
                        } finally {
                            listBtn.disabled = false;
                            listBtn.innerHTML = original;
                        }
                    });
                }

                // Auto-list properties on load to avoid manual console steps
                setTimeout(() => { if (listBtn && !propsDiv.innerHTML) listBtn.click(); }, 400);
            }

            async loadGscKpis() {
                const kpisDiv = document.getElementById('gscKpis');
                if (!kpisDiv) return;
                kpisDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading KPIs...</p>';
                const startVal = (document.getElementById('gscStart')?.value || '').trim();
                const endVal = (document.getElementById('gscEnd')?.value || '').trim();
                const type = (document.getElementById('gscType')?.value || 'web');
                if (!startVal || !endVal) {
                    kpisDiv.innerHTML = '<p>Please select a date range to view insights.</p>';
                    return;
                }
                try {
                    const url = `/api/gsc/analytics/summary?startDate=${encodeURIComponent(startVal)}&endDate=${encodeURIComponent(endVal)}&searchType=${encodeURIComponent(type)}`;
                    const resp = await fetch(url, { credentials: 'include' });
                    const data = await resp.json();
                    if (!resp.ok || !data.success) throw new Error(data.message || 'Failed to load KPIs');
                    const t = data.totals || {};
                    const clicks = (t.clicks ?? 0).toLocaleString();
                    const impr = (t.impressions ?? 0).toLocaleString();
                    const ctr = (((t.ctr ?? 0) * 100) || 0).toFixed(2) + '%';
                    const pos = ((t.position ?? 0) || 0).toFixed(1);
                    kpisDiv.innerHTML = `
                        <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-top:.5rem">
                            <div class="card" style="padding:.75rem 1rem">
                                <div style="font-size:.9rem;color:#666">Clicks</div>
                                <div style="font-size:1.25rem;font-weight:600">${clicks}</div>
                            </div>
                            <div class="card" style="padding:.75rem 1rem">
                                <div style="font-size:.9rem;color:#666">Impressions</div>
                                <div style="font-size:1.25rem;font-weight:600">${impr}</div>
                            </div>
                            <div class="card" style="padding:.75rem 1rem">
                                <div style="font-size:.9rem;color:#666">CTR</div>
                                <div style="font-size:1.25rem;font-weight:600">${ctr}</div>
                            </div>
                            <div class="card" style="padding:.75rem 1rem">
                                <div style="font-size:.9rem;color:#666">Avg Position</div>
                                <div style="font-size:1.25rem;font-weight:600">${pos}</div>
                            </div>
                        </div>
                    `;
                } catch (err) {
                    kpisDiv.innerHTML = `<p style=\"color:#c33\">${err.message}</p>`;
                }
            }

            async loadSitemaps() {
                const sitemapsList = document.getElementById('sitemapsList');
                if (!sitemapsList) return;
                sitemapsList.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading sitemaps...</p>';
                try {
                    const resp = await fetch('/api/gsc/sitemaps', { credentials: 'include' });
                    const data = await resp.json();
                    if (!resp.ok || !data.success) throw new Error(data.message || 'Failed to load sitemaps');
                    if (data.sitemaps && data.sitemaps.length > 0) {
                        sitemapsList.innerHTML = `
                            <h3>Submitted Sitemaps</h3>
                            <ul>
                                ${data.sitemaps.map(s => `<li>${s.url} (${s.lastSubmitted})</li>`).join('')}
                            </ul>
                        `;
                    } else {
                        sitemapsList.innerHTML = '<p>No sitemaps submitted yet.</p>';
                    }
                } catch (err) {
                    sitemapsList.innerHTML = `<p style=\"color:#c33\">${err.message}</p>`;
                }
            }

            async handleLogout() {
                try {
                    const response = await fetch('/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        window.location.href = '/login';
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }

            async handleChangePassword(e) {
                e.preventDefault();
                const getFieldValue = (baseId) => {
                    const pwd = document.getElementById(baseId);
                    const txt = document.getElementById(baseId + 'Text');
                    if (txt && txt.style.display !== 'none') {
                        // Visible text mirror is active (Safari show mode)
                        return txt.value;
                    }
                    return pwd ? pwd.value : '';
                };

                const currentPassword = getFieldValue('currentPassword');
                const newPassword = getFieldValue('newPassword');
                const confirmPassword = getFieldValue('confirmPassword');

                this.pwdError.style.display = 'none';
                this.pwdSuccess.style.display = 'none';

                if (newPassword !== confirmPassword) {
                    this.pwdError.textContent = 'New passwords do not match';
                    this.pwdError.style.display = 'block';
                    return;
                }

                this.changePwdBtn.disabled = true;
                const original = this.changePwdBtn.innerHTML;
                this.changePwdBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                try {
                    const res = await fetch('/api/auth/change-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ currentPassword, newPassword })
                    });
                    const data = await res.json();
                    if (!res.ok || !data.success) {
                        throw new Error(data.message || 'Failed to change password');
                    }
                    this.pwdSuccess.textContent = 'Password changed successfully';
                    this.pwdSuccess.style.display = 'block';
                    this.changePasswordForm.reset();
                } catch (err) {
                    this.pwdError.textContent = err.message;
                    this.pwdError.style.display = 'block';
                } finally {
                    this.changePwdBtn.disabled = false;
                    this.changePwdBtn.innerHTML = original;
                }
            }

            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
                this.successMessage.style.display = 'none';
            }

            showSuccess(message) {
                this.successMessage.textContent = message;
                this.successMessage.style.display = 'block';
                this.errorMessage.style.display = 'none';
            }

            hideMessages() {
                this.errorMessage.style.display = 'none';
                this.successMessage.style.display = 'none';
            }

            // Bing Sync Registry functionality
            initBingSyncRegistry() {
                const refreshBtn = document.getElementById('bingSyncRefresh');
                const discoverBtn = document.getElementById('bingDiscoverBtn');
                const schedulerTickBtn = document.getElementById('bingSchedulerTick');
                const testApiBtn = document.getElementById('bingTestApiBtn');

                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => this.loadBingSyncRegistry());
                }

                if (discoverBtn) {
                    discoverBtn.addEventListener('click', () => this.discoverBingDomains());
                }

                if (schedulerTickBtn) {
                    schedulerTickBtn.addEventListener('click', () => this.triggerBingScheduler());
                }

                if (testApiBtn) {
                    testApiBtn.addEventListener('click', () => this.testBingApi());
                }

                // Load Bing sync registry on initialization
                this.loadBingSyncRegistry();
            }

            async loadBingSyncRegistry() {
                const host = document.getElementById('bingSyncRegistry');
                if (!host) return;
                
                host.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading Bing sync registry…</p>';
                
                try {
                    const resp = await fetch('/api/bing/sync/properties', { credentials: 'include' });
                    const data = await resp.json();
                    
                    if (!resp.ok || !data.success) {
                        throw new Error(data.message || 'Failed to load Bing sync registry');
                    }
                    
                    const isAdmin = !!data.isAdmin;
                    const properties = data.properties || [];
                    
                    if (properties.length === 0) {
                        host.innerHTML = `
                            <p>No Bing domains registered yet.</p>
                            <p style="margin-top: 0.5rem; color: #666;">
                                Click "Discover Domains" to automatically find and register all available Bing Webmaster Tools domains.
                            </p>
                        `;
                        return;
                    }

                    // Sort by priority order
                    properties.sort((a, b) => (a.priorityOrder || 0) - (b.priorityOrder || 0));

                    const fmt = (d) => d ? new Date(d).toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' }) : '—';
                    
                    const table = `
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Domain</th>
                                    ${isAdmin ? '<th>User</th>' : ''}
                                    <th>Enabled</th>
                                    <th>Last Full Sync</th>
                                    <th>Next Due</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${properties.map(prop => `
                                    <tr>
                                        <td>${prop.priorityOrder ?? 0}</td>
                                        <td>
                                            <a href="/property?site=${encodeURIComponent(prop.siteUrl)}" class="view-audit-btn" target="_blank">
                                                ${prop.siteUrl}
                                            </a>
                                        </td>
                                        ${isAdmin ? `<td>${prop.email || prop.username || prop.userId || ''}</td>` : ''}
                                        <td>${prop.enabled ? 'Yes' : 'No'}</td>
                                        <td>${fmt(prop.lastFullSyncAt)}</td>
                                        <td>${fmt(prop.nextSyncDueAt)}</td>
                                        <td>
                                            <button class="audit-btn" data-bing-sync-now="${encodeURIComponent(prop.siteUrl)}" 
                                                    style="width:auto;background:#198754; margin-right:0.25rem">
                                                <i class="fas fa-forward"></i> Sync now
                                            </button>
                                            <button class="delete-btn" data-bing-unregister="${encodeURIComponent(prop.siteUrl)}" 
                                                    style="width:auto; margin-left:0.25rem">
                                                <i class="fas fa-trash"></i> Remove
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    
                    host.innerHTML = table;
                    
                    // Bind sync now buttons
                    host.querySelectorAll('[data-bing-sync-now]').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const siteUrl = decodeURIComponent(btn.getAttribute('data-bing-sync-now') || '');
                            btn.disabled = true;
                            const orig = btn.innerHTML;
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Queuing…';
                            
                            try {
                                const payload = { siteUrl, enabled: true };
                                const r = await fetch('/api/bing/sync/register', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    credentials: 'include',
                                    body: JSON.stringify(payload)
                                });
                                const d = await r.json();
                                if (!r.ok || !d.success) throw new Error(d.message || 'Failed to queue sync');
                                
                                await this.loadBingSyncRegistry();
                                this.showSuccess('Queued sync for ' + siteUrl);
                            } catch (err) {
                                this.showError(err.message);
                            } finally {
                                btn.disabled = false;
                                btn.innerHTML = orig;
                            }
                        });
                    });

                    // Bind unregister buttons
                    host.querySelectorAll('[data-bing-unregister]').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const siteUrl = decodeURIComponent(btn.getAttribute('data-bing-unregister') || '');
                            
                            if (!confirm(`Are you sure you want to remove ${siteUrl} from the Bing sync registry?`)) {
                                return;
                            }
                            
                            btn.disabled = true;
                            const orig = btn.innerHTML;
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing…';
                            
                            try {
                                const r = await fetch('/api/bing/sync/unregister', {
                                    method: 'DELETE',
                                    headers: { 'Content-Type': 'application/json' },
                                    credentials: 'include',
                                    body: JSON.stringify({ siteUrl })
                                });
                                const d = await r.json();
                                if (!r.ok || !d.success) throw new Error(d.message || 'Failed to remove domain');
                                
                                await this.loadBingSyncRegistry();
                                this.showSuccess('Removed ' + siteUrl + ' from sync registry');
                            } catch (err) {
                                this.showError(err.message);
                            } finally {
                                btn.disabled = false;
                                btn.innerHTML = orig;
                            }
                        });
                    });
                    
                } catch (err) {
                    host.innerHTML = `<p style="color:#c33">${err.message}</p>`;
                }
            }

            async discoverBingDomains() {
                const discoverBtn = document.getElementById('bingDiscoverBtn');
                if (!discoverBtn) return;
                
                discoverBtn.disabled = true;
                const orig = discoverBtn.innerHTML;
                discoverBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Discovering...';
                
                try {
                    const resp = await fetch('/api/bing/sync/discover', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    const data = await resp.json();
                    
                    if (!resp.ok || !data.success) {
                        throw new Error(data.message || 'Failed to discover domains');
                    }
                    
                    this.showSuccess(data.message || `Discovered and registered ${data.registeredSites?.length || 0} Bing domains`);
                    await this.loadBingSyncRegistry();
                    
                } catch (err) {
                    this.showError(err.message);
                } finally {
                    discoverBtn.disabled = false;
                    discoverBtn.innerHTML = orig;
                }
            }

            async triggerBingScheduler() {
                const tickBtn = document.getElementById('bingSchedulerTick');
                if (!tickBtn) return;
                
                tickBtn.disabled = true;
                const orig = tickBtn.innerHTML;
                tickBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
                
                try {
                    const resp = await fetch('/api/bing/scheduler/tick', {
                        credentials: 'include'
                    });
                    const data = await resp.json();
                    
                    if (!resp.ok || !data.success) {
                        throw new Error(data.message || 'Failed to trigger scheduler');
                    }
                    
                    this.showSuccess('Bing scheduler tick executed successfully');
                    await this.loadBingSyncRegistry();
                    
                } catch (err) {
                    this.showError(err.message);
                } finally {
                    tickBtn.disabled = false;
                    tickBtn.innerHTML = orig;
                }
            }

            async testBingApi() {
                const testBtn = document.getElementById('bingTestApiBtn');
                if (!testBtn) return;
                
                testBtn.disabled = true;
                const orig = testBtn.innerHTML;
                testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                
                try {
                    const resp = await fetch('/api/bing/test-api', {
                        credentials: 'include'
                    });
                    const data = await resp.json();
                    
                    if (!resp.ok || !data.success) {
                        throw new Error(data.message || 'API test failed');
                    }
                    
                    // Show detailed results
                    const message = `API Test Results:
• API Key Configured: ${data.apiKeyConfigured ? 'Yes' : 'No'}
• Sites Found: ${data.sites.length}
• Sites: ${data.sites.map(s => s.siteUrl).join(', ') || 'None'}`;
                    
                    this.showSuccess(message);
                    
                    // Also log to console for debugging
                    console.log('Bing API Test Results:', data);
                    
                } catch (err) {
                    this.showError(`API Test Failed: ${err.message}`);
                } finally {
                    testBtn.disabled = false;
                    testBtn.innerHTML = orig;
                }
            }
        }

        // Initialize the app
        new DashboardApp();
    </script>
</body>
</html>
