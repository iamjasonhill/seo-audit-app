<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Property - SEO Audit App</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#f5f7fa; color:#333; }
    .top { background:#fff; box-shadow:0 2px 4px rgba(0,0,0,.08); padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:5 }
    .container { max-width:1200px; margin:1.5rem auto; padding:0 1rem; }
    .h1 { font-size:1.4rem; font-weight:700; display:flex; gap:.5rem; align-items:center; }
    .tabs { display:flex; gap:.5rem; flex-wrap:wrap; margin:1rem 0; }
    .tab { background:#e9ecf1; border:none; padding:.5rem .75rem; border-radius:6px; cursor:pointer; }
    .tab.active { background:#667eea; color:#fff; }
    .card { background:#fff; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.08); padding:1rem; margin-bottom:1rem; }
    .controls { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:.5rem; }
    .history-table { width:100%; border-collapse:collapse; }
    .history-table th, .history-table td { padding:.6rem; text-align:left; border-bottom:1px solid #e1e5e9; }
    .audit-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border:none; border-radius:6px; padding:.5rem .75rem; cursor:pointer; display:inline-flex; align-items:center; gap:.4rem; }
    .muted { color:#666; font-size:.9rem }
    .error { color:#c33; margin:.5rem 0 }
    .source-pill { display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .5rem; border-radius:999px; font-size:.75rem; border:1px solid #e1e5e9; background:#f8f9fa; color:#555; }
    .source-db { background:#e8f5e9; border-color:#c8e6c9; color:#2e7d32; }
    .source-live { background:#eef2ff; border-color:#dde3ff; color:#4a57d1; }
  </style>
  <script>
    // Small helpers reused from dashboard
    const qs = (k) => new URLSearchParams(location.search).get(k);
    const fmtNum = (n) => (n ?? 0).toLocaleString();
    const pct = (v) => (((v ?? 0) * 100) || 0).toFixed(2) + '%';

    async function ensureSelectedProperty(siteUrl) {
      try {
        const selResp = await fetch('/api/gsc/selected', { credentials:'include' });
        const sel = await selResp.json();
        if (!selResp.ok || !sel.success || sel.selected !== siteUrl) {
          await fetch('/api/gsc/selected', {
            method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
            body: JSON.stringify({ siteUrl })
          });
        }
      } catch (e) {}
    }

    function deriveAuditUrl(siteParam) {
      if (!siteParam) return '';
      if (siteParam.startsWith('sc-domain:')) {
        const domain = siteParam.replace('sc-domain:', '').trim();
        if (!domain) return '';
        return `https://${domain}/`;
      }
      if (/^https?:\/\//i.test(siteParam)) return siteParam;
      return siteParam;
    }

    async function loadKpis(range, searchType) {
      const el = document.getElementById('kpis');
      const src = document.getElementById('kpiSource');
      el.innerHTML = '<p class="muted"><i class="fas fa-spinner fa-spin"></i> Loading KPIs...</p>';
      const url = `/api/gsc/analytics/summary?startDate=${range.start}&endDate=${range.end}&searchType=${searchType}`;
      const r = await fetch(url, { credentials:'include' }); const d = await r.json();
      if (!r.ok || !d.success) { el.innerHTML = `<p class="error">${d.message||'Failed to load KPIs'}</p>`; return; }
      // Source indicator with DB coverage
      if (src) {
        src.style.display = 'inline-flex';
        const setDb = (cov) => {
          const covText = (cov && cov.start && cov.end) ? `Saved data • ${cov.start} → ${cov.end}` : 'Saved data';
          src.textContent = covText;
          src.className = 'source-pill source-db';
        };
        if (d.source === 'db') {
          if (d.coverage) { setDb(d.coverage); }
          // Always fetch authoritative coverage to ensure display even if summary omitted it
          const type = document.getElementById('stype').value || searchType || 'web';
          fetch(`/api/gsc/coverage?searchType=${encodeURIComponent(type)}`, { credentials:'include' })
            .then(r=>r.json()).then(x=> setDb(x.coverage || null))
            .catch(()=> setDb(null));
        } else {
          src.textContent = 'Live from Google';
          src.className = 'source-pill source-live';
        }
      }
      const t = d.totals||{};
      // Compute comparison vs previous period of same length
      const startDate = new Date(range.start);
      const endDate = new Date(range.end);
      const days = Math.max(1, Math.round((endDate - startDate) / (24*60*60*1000)) + 1);
      const prevEnd = new Date(startDate.getTime() - 24*60*60*1000);
      const prevStart = new Date(prevEnd.getTime() - (days-1)*24*60*60*1000);
      const iso = (d)=>d.toISOString().slice(0,10);
      let deltas = { clicks: 0, impressions: 0, ctr: 0, position: 0 };
      try {
        const url2 = `/api/gsc/analytics/summary?startDate=${iso(prevStart)}&endDate=${iso(prevEnd)}&searchType=${searchType}`;
        const r2 = await fetch(url2, { credentials:'include' }); const d2 = await r2.json();
        if (r2.ok && d2.success) {
          const p = d2.totals||{};
          deltas = {
            clicks: (t.clicks||0) - (p.clicks||0),
            impressions: (t.impressions||0) - (p.impressions||0),
            ctr: (t.ctr||0) - (p.ctr||0),
            position: (t.position||0) - (p.position||0)
          };
        }
      } catch(_) {}

      const deltaTag = (v, isInverse=false) => {
        const sign = v>0?'+':'';
        const val = isInverse ? (-v) : v; // for position, lower is better
        const color = val>0?'#198754': (val<0?'#c33':'#666');
        const fmt = (typeof v==='number' && Math.abs(v)<1 && !isInverse) ? pct(v) : (typeof v==='number'? (isInverse? val.toFixed(1): Math.round(val).toLocaleString()) : '');
        return `<span style="color:${color};font-size:.85rem;margin-left:.35rem">${sign}${fmt}</span>`;
      };

      el.innerHTML = `<div style="display:flex;gap:1rem;flex-wrap:wrap">
        <div class="card" style="padding:.75rem 1rem"><div class="muted">Clicks</div><div style="font-weight:700;font-size:1.2rem">${fmtNum(t.clicks)}${deltaTag(deltas.clicks)}</div></div>
        <div class="card" style="padding:.75rem 1rem"><div class="muted">Impressions</div><div style="font-weight:700;font-size:1.2rem">${fmtNum(t.impressions)}${deltaTag(deltas.impressions)}</div></div>
        <div class="card" style="padding:.75rem 1rem"><div class="muted">CTR</div><div style="font-weight:700;font-size:1.2rem">${pct(t.ctr)}${deltaTag(deltas.ctr)}</div></div>
        <div class="card" style="padding:.75rem 1rem"><div class="muted">Avg Pos</div><div style="font-weight:700;font-size:1.2rem">${(t.position||0).toFixed(1)}${deltaTag(deltas.position, true)}</div></div>
      </div>`;
    }

    async function loadAudits(siteParam) {
      const el = document.getElementById('audits');
      el.innerHTML = '<p class="muted"><i class="fas fa-spinner fa-spin"></i> Loading audits...</p>';

      const variants = (() => {
        // Try to map property to likely audited URLs
        if (siteParam && siteParam.startsWith('sc-domain:')) {
          const d = siteParam.replace('sc-domain:','');
          return [
            `https://${d}/`,
            `https://www.${d}/`,
            `http://${d}/`,
            `http://www.${d}/`
          ];
        }
        return [siteParam];
      })();

      let rows = [];
      for (const v of variants) {
        try {
          const r = await fetch(`/api/audit/history/${encodeURIComponent(v)}?limit=25`, { credentials:'include' });
          const d = await r.json();
          if (r.ok && d.success && Array.isArray(d.history)) {
            rows = rows.concat(d.history);
          }
        } catch (_) { /* ignore */ }
        if (rows.length > 0) break; // first hit wins
      }

      // Deduplicate by id
      const unique = Object.values(rows.reduce((acc, a) => { acc[a.id]=a; return acc; }, {}));

      if (unique.length === 0) { el.innerHTML = '<p class="muted">No audits yet for this property.</p>'; return; }
      unique.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
      el.innerHTML = `<table class="history-table"><thead><tr><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody>
        ${unique.map(a => `<tr>
          <td>${new Date(a.createdAt).toLocaleString(undefined,{dateStyle:'short',timeStyle:'short'})}</td>
          <td>${a.hasResults ? 'Complete' : 'Pending'}</td>
          <td><a class="audit-btn" href="/report.html?auditId=${a.id}" target="_blank"><i class="fas fa-eye"></i> View</a></td>
        </tr>`).join('')}
      </tbody></table>`;
    }

    function getDefaultRange() {
      const now = new Date();
      const end = new Date(now.getTime() - 3*24*60*60*1000); // default to 3 days ago to align with GSC data availability
      const start = new Date(end.getTime() - 27*24*60*60*1000);
      const iso = (d)=>d.toISOString().slice(0,10);
      return { start: iso(start), end: iso(end) };
    }

    async function initPropertyPage() {
      const site = qs('site');
      if (!site) { document.getElementById('err').textContent = 'Missing site parameter'; return; }
      document.getElementById('siteLabel').textContent = site;
      // Set GSC link
      const gscLink = document.getElementById('openGsc');
      if (gscLink) {
        // GSC property URLs: domain properties use sc-domain:, URL-prefix properties use the encoded URL
        const target = site.startsWith('sc-domain:')
          ? `https://search.google.com/search-console?resource_id=${encodeURIComponent(site)}`
          : `https://search.google.com/search-console?resource_id=${encodeURIComponent(site)}`;
        gscLink.href = target;
      }
      await ensureSelectedProperty(site);

      // New Audit form
      const auditUrlEl = document.getElementById('auditUrl');
      const auditTypeEl = document.getElementById('auditType');
      const runBtn = document.getElementById('runAuditBtn');
      const auditMsg = document.getElementById('auditMsg');
      const defaultUrl = deriveAuditUrl(site);
      if (auditUrlEl) auditUrlEl.value = defaultUrl;
      if (runBtn) runBtn.addEventListener('click', async () => {
        const url = (auditUrlEl.value || '').trim();
        const sType = auditTypeEl.value;
        auditMsg.textContent = '';
        if (!/^https?:\/\//i.test(url)) { auditMsg.textContent = 'Please enter a valid URL (including http/https).'; return; }
        const original = runBtn.innerHTML; runBtn.disabled = true; runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
        try {
          const resp = await fetch('/api/audit', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ siteUrl: url, siteType: sType }) });
          const data = await resp.json();
          if (!resp.ok || !data.success) throw new Error(data.message || 'Audit failed');
          auditMsg.style.color = '#155724';
          auditMsg.textContent = 'Audit completed successfully';
          await loadAudits(url);
        } catch (e) {
          auditMsg.style.color = '#c33';
          auditMsg.textContent = e.message;
        } finally { runBtn.disabled = false; runBtn.innerHTML = original; }
      });

      // Controls
      const startEl = document.getElementById('start');
      const endEl = document.getElementById('end');
      const typeEl = document.getElementById('stype');
      const applyBtn = document.getElementById('apply');
      const range = getDefaultRange();
      startEl.value = range.start; endEl.value = range.end;
      const loadAll = async () => {
        await loadKpis({ start: startEl.value, end: endEl.value }, typeEl.value);
        await loadAudits(site);
        // Load insights (current active tab)
        if (window.__insightsLoad) await window.__insightsLoad();
      };
      applyBtn.addEventListener('click', loadAll);
      // Quick search type buttons
      const setType = (v)=>{ typeEl.value = v; loadAll(); };
      document.getElementById('tWeb').onclick = ()=>setType('web');
      document.getElementById('tImage').onclick = ()=>setType('image');
      document.getElementById('tVideo').onclick = ()=>setType('video');
      document.getElementById('tNews').onclick = ()=>setType('news');
      document.getElementById('tDiscover').onclick = ()=>setType('discover');
      await loadAll();

      // Initialize URL Inspection and Sitemaps panels
      initPropUrlInspection();
      initPropSitemaps();

      // Hide Data Sync card once initial 16 months coverage is complete
      async function hideSyncCardIfComplete() {
        const card = document.getElementById('syncCard');
        if (!card) return;
        try {
          const types = ['web','image','video'];
          const results = await Promise.all(types.map(t =>
            fetch(`/api/gsc/coverage?searchType=${encodeURIComponent(t)}`, { credentials:'include' })
              .then(r=>r.json()).catch(()=>({}))
          ));
          const complete = results.every(x => {
            const cov = x && x.coverage; if (!cov || !cov.start || !cov.end) return false;
            const sd = new Date(cov.start + 'T00:00:00Z');
            const ed = new Date(cov.end + 'T00:00:00Z');
            const days = Math.round((ed - sd) / (24*60*60*1000));
            return days >= 475; // ~16 months
          });
          if (complete) card.style.display = 'none';
        } catch (_) { /* ignore */ }
      }

      // Backfill button and sync status
      const backfillBtn = document.getElementById('backfillBtn');
      const backfillMsg = document.getElementById('backfillMsg');
      const syncStatus = document.getElementById('syncStatus');
      async function loadSync() {
        try {
          const r = await fetch(`/api/gsc/sync-status?siteUrl=${encodeURIComponent(site)}`, { credentials:'include' });
          const d = await r.json();
          if (!r.ok || !d.success) throw new Error(d.message||'Failed to load sync status');
          const rows = d.status || [];
          if (!rows.length) { syncStatus.textContent = 'No sync activity yet.'; return; }
          const fmt = (s) => s ? new Date(s).toLocaleString(undefined,{ dateStyle:'short', timeStyle:'short' }) : '—';
          const html = `<table class="history-table"><thead><tr><th>Dimension</th><th>Type</th><th>Last Synced</th><th>Status</th><th>Updated</th></tr></thead><tbody>
            ${rows.map(r=>`<tr><td>${r.dimension}</td><td>${r.searchType}</td><td>${fmt(r.lastSyncedDate)}</td><td>${r.status||'—'}</td><td>${fmt(r.lastRunAt)}</td></tr>`).join('')}
          </tbody></table>`;
          syncStatus.innerHTML = html;
        } catch(e) {
          syncStatus.textContent = e.message;
        }
        // After every refresh of sync status, check if we can hide the card
        hideSyncCardIfComplete();
      }
      if (backfillBtn) backfillBtn.addEventListener('click', async () => {
        backfillMsg.style.color = '#666';
        backfillMsg.textContent = 'Starting backfill… this may take a while.';
        backfillBtn.disabled = true;
        const orig = backfillBtn.innerHTML; backfillBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Backfilling…';
        try {
          const resp = await fetch('/api/gsc/backfill', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ searchTypes: ['web','image','video'] }) });
          const data = await resp.json();
          if (!resp.ok || !data.success) throw new Error(data.message||'Backfill failed');
          backfillMsg.style.color = '#155724';
          backfillMsg.textContent = 'Backfill completed.';
        } catch(e) {
          backfillMsg.style.color = '#c33';
          backfillMsg.textContent = e.message;
        } finally {
          backfillBtn.disabled = false; backfillBtn.innerHTML = orig; loadSync();
        }
      });
      // Initial sync status load
      loadSync();
      // Also check on initial page load
      hideSyncCardIfComplete();
    }

    document.addEventListener('DOMContentLoaded', initPropertyPage);
  </script>
</head>
<body>
  <div class="top">
    <div class="h1"><i class="fas fa-globe"></i> Property <span class="muted">—</span> <span id="siteLabel" class="muted"></span></div>
    <div>
      <a href="/dashboard" class="audit-btn" style="background:#6c757d"><i class="fas fa-arrow-left"></i> Dashboard</a>
      <a id="openGsc" href="#" class="audit-btn" style="margin-left:.5rem;background:#198754" target="_blank"><i class="fab fa-google"></i> Open in GSC</a>
    </div>
  </div>
  <div class="container">
    <div id="err" class="error"></div>

    <div class="card">
      <h3 style="margin:.25rem 0 1rem 0"><i class="fas fa-play"></i> New Audit</h3>
      <div class="controls">
        <div style="flex:1">
          <label class="muted">URL</label>
          <input type="url" id="auditUrl" placeholder="https://example.com/" style="width:100%;padding:.6rem;border:1px solid #e1e5e9;border-radius:6px">
        </div>
        <div>
          <label class="muted">Site Type</label>
          <select id="auditType" style="padding:.6rem;border:1px solid #e1e5e9;border-radius:6px">
            <option value="Generic" selected>Generic</option>
            <option value="SaaS">SaaS</option>
            <option value="Ecommerce">Ecommerce</option>
            <option value="Agency">Agency</option>
            <option value="Local">Local</option>
          </select>
        </div>
        <button id="runAuditBtn" class="audit-btn"><i class="fas fa-play"></i> Run Audit</button>
      </div>
      <div id="auditMsg" class="muted" style="margin-top:.5rem"></div>
    </div>

    <div class="card">
      <div class="controls">
        <div><label class="muted">Start</label> <input type="date" id="start"></div>
        <div><label class="muted">End</label> <input type="date" id="end"></div>
        <div>
          <label class="muted">Type</label>
          <select id="stype"><option value="web" selected>Web</option><option value="image">Image</option><option value="video">Video</option><option value="news">News</option><option value="discover">Discover</option></select>
        </div>
        <button id="apply" class="audit-btn"><i class="fas fa-check"></i> Apply</button>
        <span id="kpiSource" class="source-pill" style="margin-left:.5rem; display:none"></span>
      </div>
      <div class="controls" style="margin-top:.25rem">
        <span class="muted">Quick types:</span>
        <button class="audit-btn" id="tWeb" style="background:#6c757d">Web</button>
        <button class="audit-btn" id="tImage" style="background:#6c757d">Image</button>
        <button class="audit-btn" id="tVideo" style="background:#6c757d">Video</button>
        <button class="audit-btn" id="tNews" style="background:#6c757d">News</button>
        <button class="audit-btn" id="tDiscover" style="background:#6c757d">Discover</button>
      </div>
      <div id="kpis"></div>
    </div>

    <div class="card" id="syncCard">
      <h3 style="margin:.25rem 0 1rem 0"><i class="fas fa-database"></i> Data Sync</h3>
      <div class="controls">
        <button id="backfillBtn" class="audit-btn" style="background:#0d6efd"><i class="fas fa-cloud-download-alt"></i> Backfill last 16 months</button>
        <span id="backfillMsg" class="muted"></span>
      </div>
      <div id="syncStatus" class="muted">No sync activity yet.</div>
    </div>

    <div class="card">
      <h3 style="margin:.25rem 0 1rem 0"><i class="fas fa-history"></i> Recent Audits</h3>
      <div id="audits"></div>
    </div>

    <div class="card">
      <h3 style="margin:.25rem 0 1rem 0"><i class="fas fa-chart-pie"></i> GSC Insights</h3>
      <div class="controls">
        <div>
          <label class="muted">Rows</label>
          <select id="prow" style="padding:.4rem;border:1px solid #e1e5e9;border-radius:6px">
            <option value="50" selected>50</option>
            <option value="100">100</option>
            <option value="500">500</option>
          </select>
        </div>
        <button id="pPages"   class="audit-btn"><i class="fas fa-file-alt"></i> Pages</button>
        <button id="pQueries" class="audit-btn" style="background:#6c757d"><i class="fas fa-search"></i> Queries</button>
        <button id="pDevice"  class="audit-btn" style="background:#6c757d"><i class="fas fa-mobile-alt"></i> Device</button>
        <button id="pCountry" class="audit-btn" style="background:#6c757d"><i class="fas fa-globe"></i> Country</button>
        <button id="pAppear"  class="audit-btn" style="background:#6c757d"><i class="fas fa-star"></i> Appearance</button>
      </div>
      <div id="pSource" class="muted" style="margin:.25rem 0 .25rem 0"></div>
      <div id="pInsights"></div>
      <div id="pPager" style="margin-top:.5rem; display:flex; gap:.5rem; align-items:center"></div>
      <div id="pOpps" style="margin-top:1rem"></div>
    </div>

    <div class="card">
      <h3 style="margin:.25rem 0 1rem 0"><i class="fas fa-search-location"></i> URL Inspection</h3>
      <div class="controls">
        <div style="flex:1">
          <label class="muted">URL</label>
          <input type="url" id="pInspectUrl" placeholder="https://example.com/page" style="width:100%;padding:.6rem;border:1px solid #e1e5e9;border-radius:6px">
        </div>
        <button id="pInspectBtn" class="audit-btn"><i class="fas fa-search"></i> Inspect</button>
      </div>
      <div id="pInspectOut" style="margin-top:.5rem"></div>
    </div>

    <div class="card">
      <h3 style="margin:.25rem 0 1rem 0"><i class="fas fa-sitemap"></i> Sitemaps</h3>
      <div class="controls">
        <div style="flex:1"><input type="url" id="pSitemapUrl" placeholder="https://example.com/sitemap.xml" style="width:100%;padding:.6rem;border:1px solid #e1e5e9;border-radius:6px"></div>
        <button id="pSitemapSubmit" class="audit-btn"><i class="fas fa-paper-plane"></i> Submit</button>
      </div>
      <div id="pSitemaps" style="margin-top:.5rem"></div>
    </div>
  </div>

  <script>
    // Insights logic for property page
    (function(){
      const byId = (id) => document.getElementById(id);
      const startEl = byId('start');
      const endEl = byId('end');
      const typeEl = byId('stype');
      const rowsEl = byId('prow');
      const out = byId('pInsights');
      const ps = byId('pSource');
      const pager = byId('pPager');
      const btns = {
        pages: byId('pPages'),
        queries: byId('pQueries'),
        device: byId('pDevice'),
        country: byId('pCountry'),
        appearance: byId('pAppear')
      };
      let endpoint = '/api/gsc/analytics/pages';
      let tab = 'pages';
      let rowLimit = 50;
      let startRow = 0;

      const setActive = (key) => {
        Object.entries(btns).forEach(([k, b]) => { if (b) b.style.background = (k===key? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#6c757d'); });
      };

      const buildUrl = () => {
        const params = new URLSearchParams();
        params.append('startDate', startEl.value);
        params.append('endDate', endEl.value);
        params.append('searchType', typeEl.value);
        params.append('rowLimit', String(rowLimit));
        params.append('startRow', String(startRow));
        return `${endpoint}?${params.toString()}`;
      };

      const render = (rows, prevMap) => {
        if (!rows || rows.length === 0) { out.innerHTML = '<p class="muted">No data for selected range.</p>'; pager.innerHTML=''; return; }
        const label = tab==='pages'?'Page':tab==='queries'?'Query':tab==='device'?'Device':tab==='country'?'Country':'Appearance';
        const firstVal = (r)=> tab==='pages'?r.page: tab==='queries'?r.query: tab==='device'?r.device: tab==='country'?r.country: r.appearance;
        out.innerHTML = `<table class="history-table"><thead><tr><th>${label}</th><th>Clicks</th><th>Impr</th><th>CTR</th><th>Pos</th></tr></thead><tbody>
          ${rows.map(r=>`<tr><td>${firstVal(r)||''}</td><td>${(r.clicks||0).toLocaleString()}</td><td>${(r.impressions||0).toLocaleString()}</td><td>${(((r.ctr||0)*100)||0).toFixed(2)}%</td><td>${((r.position||0)||0).toFixed(1)}</td></tr>`).join('')}
        </tbody></table>`;
        pager.innerHTML = `
          <button id="pgPrev2" class="audit-btn" style="width:auto;background:#6c757d" ${startRow===0?'disabled':''}><i class="fas fa-chevron-left"></i> Prev</button>
          <span class="muted">Rows ${startRow+1}–${startRow+rows.length}</span>
          <button id="pgNext2" class="audit-btn" style="width:auto"><i class="fas fa-chevron-right"></i> Next</button>`;
        const prev = byId('pgPrev2'); const next = byId('pgNext2');
        if (prev) prev.onclick = ()=>{ if (startRow>0){ startRow=Math.max(0,startRow-rowLimit); load(); }};
        if (next) next.onclick = ()=>{ startRow += rowLimit; load(); };

        // Opportunities
        const opps = document.getElementById('pOpps');
        const lowCtr = rows.filter(r => (r.impressions||0) > 1000 && (r.ctr||0) < 0.01)
                           .sort((a,b)=> (b.impressions||0) - (a.impressions||0)).slice(0,5);
        const nearP1 = rows.filter(r => (r.impressions||0) > 500 && (r.position||0) >= 8 && (r.position||0) <= 15)
                           .sort((a,b)=> (a.position||0) - (b.position||0)).slice(0,5);
        // Rising/Falling by clicks – needs previous map if available
        const rising = []; const falling = [];
        if (prevMap) {
          rows.forEach(r=>{ const k = firstVal(r)||''; const p = prevMap[k]||{}; const dv = (r.clicks||0) - (p.clicks||0); if (dv>0) rising.push({k, dv}); if (dv<0) falling.push({k, dv}); });
          rising.sort((a,b)=> b.dv - a.dv); falling.sort((a,b)=> a.dv - b.dv);
        }
        const list = (arr, fmt) => arr.length ? `<ul>${arr.map(fmt).join('')}</ul>` : '<p class="muted">None</p>';
        opps.innerHTML = `
          <div class="card" style="padding:.75rem 1rem">
            <div style="font-weight:600;margin-bottom:.5rem">Opportunities</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
              <div>
                <div class="muted">Low CTR</div>
                ${list(lowCtr, r=>`<li>${firstVal(r)||''} – CTR ${(((r.ctr||0)*100)||0).toFixed(2)}%, Impr ${(r.impressions||0).toLocaleString()}</li>`)}
              </div>
              <div>
                <div class="muted">Near Page One</div>
                ${list(nearP1, r=>`<li>${firstVal(r)||''} – Pos ${((r.position||0)||0).toFixed(1)}, Impr ${(r.impressions||0).toLocaleString()}</li>`)}
              </div>
              <div>
                <div class="muted">Rising (Clicks)</div>
                ${list(rising.slice(0,5), x=>`<li>${x.k} – +${x.dv.toLocaleString()}</li>`)}
              </div>
              <div>
                <div class="muted">Falling (Clicks)</div>
                ${list(falling.slice(0,5), x=>`<li>${x.k} – ${x.dv.toLocaleString()}</li>`)}
              </div>
            </div>
          </div>`;
      };

      async function load(){
        out.innerHTML = '<p class="muted"><i class="fas fa-spinner fa-spin"></i> Loading…</p>';
        try {
          const r = await fetch(buildUrl(), { credentials:'include' });
          const d = await r.json();
          if (!r.ok || !d.success) throw new Error(d.message||'Failed to load');
          if (ps) ps.textContent = d.source ? (d.source==='db' ? 'Source: saved data' : 'Source: live from Google') : '';
          // Fetch previous period for rising/falling
          let prevMap = null;
          try {
            const s = new Date(startEl.value); const e = new Date(endEl.value);
            const days = Math.max(1, Math.round((e - s)/(24*60*60*1000))+1);
            const pe = new Date(s.getTime() - 24*60*60*1000);
            const ps = new Date(pe.getTime() - (days-1)*24*60*60*1000);
            const iso = (d)=>d.toISOString().slice(0,10);
            const params = new URLSearchParams();
            params.append('startDate', iso(ps)); params.append('endDate', iso(pe));
            params.append('searchType', typeEl.value);
            params.append('rowLimit', String(rowLimit));
            params.append('startRow', String(startRow));
            const r2 = await fetch(`${endpoint}?${params.toString()}`, { credentials:'include' });
            const d2 = await r2.json();
            if (r2.ok && d2.success) {
              const key = (row)=> tab==='pages'?row.page: tab==='queries'?row.query: tab==='device'?row.device: tab==='country'?row.country: row.appearance;
              prevMap = (d2.data||[]).reduce((acc,row)=>{ acc[key(row)||''] = row; return acc; }, {});
            }
          } catch(_) {}
          render(d.data, prevMap);
        } catch(e){ out.innerHTML = `<p class="error">${e.message}</p>`; pager.innerHTML=''; }
      }

      // public hook so the top Apply button can reload current tab
      window.__insightsLoad = load;

      if (rowsEl) rowsEl.onchange = ()=>{ rowLimit=parseInt(rowsEl.value||'50',10); startRow=0; load(); };
      if (btns.pages) btns.pages.onclick = ()=>{ endpoint='/api/gsc/analytics/pages'; tab='pages'; setActive('pages'); startRow=0; load(); };
      if (btns.queries) btns.queries.onclick = ()=>{ endpoint='/api/gsc/analytics/queries'; tab='queries'; setActive('queries'); startRow=0; load(); };
      if (btns.device) btns.device.onclick = ()=>{ endpoint='/api/gsc/analytics/device'; tab='device'; setActive('device'); startRow=0; load(); };
      if (btns.country) btns.country.onclick = ()=>{ endpoint='/api/gsc/analytics/country'; tab='country'; setActive('country'); startRow=0; load(); };
      if (btns.appearance) btns.appearance.onclick = ()=>{ endpoint='/api/gsc/analytics/appearance'; tab='appearance'; setActive('appearance'); startRow=0; load(); };

      // default
      setActive('pages'); load();
    })();

    // Property URL Inspection panel
    function initPropUrlInspection(){
      const input = document.getElementById('pInspectUrl');
      const btn = document.getElementById('pInspectBtn');
      const out = document.getElementById('pInspectOut');
      if (!btn || !input || !out) return;
      btn.addEventListener('click', async () => {
        const url = (input.value||'').trim();
        out.innerHTML = '';
        if (!/^https?:\/\//i.test(url)) { out.innerHTML = '<p class="error">Enter a valid URL including http/https.</p>'; return; }
        const orig = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Inspecting...';
        try {
          const resp = await fetch('/api/gsc/url/inspect', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ url }) });
          const data = await resp.json();
          if (!resp.ok || !data.success) throw new Error(data.message || 'Inspection failed');
          const r = data.result || {}; const idx = r.indexStatusResult || {}; const mobi = r.mobileUsabilityResult || {}; const amp = r.ampResult || {};
          out.innerHTML = `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:.5rem">
              <div class="card" style="padding:.75rem 1rem">
                <div class="muted">Index Status</div>
                <div><strong>Verdict:</strong> ${idx.verdict||'Unknown'}</div>
                <div><strong>Coverage State:</strong> ${idx.coverageState||'Unknown'}</div>
                <div><strong>Last Crawl:</strong> ${idx.lastCrawlTime||'—'}</div>
                <div><strong>Robots:</strong> ${idx.robotsTxtState||'Unknown'}</div>
                <div><strong>Noindex:</strong> ${idx.indexingState||'Unknown'}</div>
                <div><strong>User Canonical:</strong> ${idx.userCanonical||'—'}</div>
                <div><strong>Google Canonical:</strong> ${idx.googleCanonical||'—'}</div>
              </div>
              <div class="card" style="padding:.75rem 1rem">
                <div class="muted">Mobile Usability</div>
                <div><strong>Status:</strong> ${mobi.verdict||'Unknown'}</div>
                <div><strong>Issues:</strong> ${(mobi.issues&&mobi.issues.length)?mobi.issues.map(i=>i.message).join(', '):'None'}</div>
                <div style="margin-top:.5rem" class="muted">AMP: ${amp.verdict||'Unknown'}</div>
              </div>
            </div>`;
        } catch(e){ out.innerHTML = `<p class="error">${e.message}</p>`; }
        finally{ btn.disabled=false; btn.innerHTML = orig; }
      });
    }

    // Property Sitemaps panel
    function initPropSitemaps(){
      const list = document.getElementById('pSitemaps');
      const btn = document.getElementById('pSitemapSubmit');
      const input = document.getElementById('pSitemapUrl');
      if (!list || !btn || !input) return;
      const render = (items)=>{
        if (!items || items.length===0){ list.innerHTML = '<p class="muted">No sitemaps found for this property.</p>'; return; }
        const rows = items.map(s=>`<tr><td>${s.path||s.url||''}</td><td>${s.isIndex?'Index':'File'}</td><td>${s.lastSubmitted||'—'}</td><td>${s.lastDownloaded||'—'}</td><td>${s.warnings||0}</td><td>${s.errors||0}</td></tr>`).join('');
        list.innerHTML = `<table class="history-table"><thead><tr><th>Path</th><th>Type</th><th>Last Submitted</th><th>Last Downloaded</th><th>Warnings</th><th>Errors</th></tr></thead><tbody>${rows}</tbody></table>`;
      };
      const load = async ()=>{
        list.innerHTML = '<p class="muted"><i class="fas fa-spinner fa-spin"></i> Loading…</p>';
        try { const r = await fetch('/api/gsc/sitemaps', { credentials:'include' }); const d = await r.json(); if (!r.ok||!d.success) throw new Error(d.message||'Failed to load'); render(d.sitemaps); }
        catch(e){ list.innerHTML = `<p class=\"error\">${e.message}</p>`; }
      };
      btn.addEventListener('click', async ()=>{
        const url = (input.value||'').trim(); if (!/^https?:\/\//i.test(url)) { list.innerHTML = '<p class="error">Enter a valid sitemap URL.</p>'; return; }
        const orig=btn.innerHTML; btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Submitting';
        try{ const r = await fetch('/api/gsc/sitemaps/submit',{ method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ sitemapUrl:url }) }); const d=await r.json(); if (!r.ok||!d.success) throw new Error(d.message||'Submit failed'); await load(); }
        catch(e){ list.innerHTML = `<p class=\"error\">${e.message}</p>`; }
        finally{ btn.disabled=false; btn.innerHTML=orig; }
      });
      load();
    }
  </script>
</body>
</html>


