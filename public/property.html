<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Property - SEO Audit App</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#f5f7fa; color:#333; }
    .top { background:#fff; box-shadow:0 2px 4px rgba(0,0,0,.08); padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:5 }
    .container { max-width:1200px; margin:1.5rem auto; padding:0 1rem; }
    .h1 { font-size:1.4rem; font-weight:700; display:flex; gap:.5rem; align-items:center; }
    .tabs { display:flex; gap:.5rem; flex-wrap:wrap; margin:1rem 0; }
    .tab { background:#e9ecf1; border:none; padding:.5rem .75rem; border-radius:6px; cursor:pointer; }
    .tab.active { background:#667eea; color:#fff; }
    .card { background:#fff; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.08); padding:1rem; margin-bottom:1rem; }
    .controls { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:.5rem; }
    .history-table { width:100%; border-collapse:collapse; }
    .history-table th, .history-table td { padding:.6rem; text-align:left; border-bottom:1px solid #e1e5e9; }
    .audit-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border:none; border-radius:6px; padding:.5rem .75rem; cursor:pointer; display:inline-flex; align-items:center; gap:.4rem; }
    .muted { color:#666; font-size:.9rem }
    .error { color:#c33; margin:.5rem 0 }
  </style>
  <script>
    // Small helpers reused from dashboard
    const qs = (k) => new URLSearchParams(location.search).get(k);
    const fmtNum = (n) => (n ?? 0).toLocaleString();
    const pct = (v) => (((v ?? 0) * 100) || 0).toFixed(2) + '%';

    async function ensureSelectedProperty(siteUrl) {
      try {
        const selResp = await fetch('/api/gsc/selected', { credentials:'include' });
        const sel = await selResp.json();
        if (!selResp.ok || !sel.success || sel.selected !== siteUrl) {
          await fetch('/api/gsc/selected', {
            method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
            body: JSON.stringify({ siteUrl })
          });
        }
      } catch (e) {}
    }

    function deriveAuditUrl(siteParam) {
      if (!siteParam) return '';
      if (siteParam.startsWith('sc-domain:')) {
        const domain = siteParam.replace('sc-domain:', '').trim();
        if (!domain) return '';
        return `https://${domain}/`;
      }
      if (/^https?:\/\//i.test(siteParam)) return siteParam;
      return siteParam;
    }

    async function loadKpis(range, searchType) {
      const el = document.getElementById('kpis');
      el.innerHTML = '<p class="muted"><i class="fas fa-spinner fa-spin"></i> Loading KPIs...</p>';
      const url = `/api/gsc/analytics/summary?startDate=${range.start}&endDate=${range.end}&searchType=${searchType}`;
      const r = await fetch(url, { credentials:'include' }); const d = await r.json();
      if (!r.ok || !d.success) { el.innerHTML = `<p class="error">${d.message||'Failed to load KPIs'}</p>`; return; }
      const t = d.totals||{};
      el.innerHTML = `<div style="display:flex;gap:1rem;flex-wrap:wrap">
        <div class="card" style="padding:.75rem 1rem"><div class="muted">Clicks</div><div style="font-weight:700;font-size:1.2rem">${fmtNum(t.clicks)}</div></div>
        <div class="card" style="padding:.75rem 1rem"><div class="muted">Impressions</div><div style="font-weight:700;font-size:1.2rem">${fmtNum(t.impressions)}</div></div>
        <div class="card" style="padding:.75rem 1rem"><div class="muted">CTR</div><div style="font-weight:700;font-size:1.2rem">${pct(t.ctr)}</div></div>
        <div class="card" style="padding:.75rem 1rem"><div class="muted">Avg Pos</div><div style="font-weight:700;font-size:1.2rem">${(t.position||0).toFixed(1)}</div></div>
      </div>`;
    }

    async function loadAudits(siteUrl) {
      const el = document.getElementById('audits');
      el.innerHTML = '<p class="muted"><i class="fas fa-spinner fa-spin"></i> Loading audits...</p>';
      const r = await fetch(`/api/audit/history/${encodeURIComponent(siteUrl)}?limit=25`, { credentials:'include' });
      const d = await r.json();
      if (!r.ok || !d.success) { el.innerHTML = `<p class="error">${d.message||'Failed to load audits'}</p>`; return; }
      const rows = d.history || [];
      if (rows.length === 0) { el.innerHTML = '<p class="muted">No audits yet for this property.</p>'; return; }
      el.innerHTML = `<table class="history-table"><thead><tr><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody>
        ${rows.map(a => `<tr>
          <td>${new Date(a.createdAt).toLocaleString(undefined,{dateStyle:'short',timeStyle:'short'})}</td>
          <td>${a.hasResults ? 'Complete' : 'Pending'}</td>
          <td><a class="audit-btn" href="/report.html?auditId=${a.id}" target="_blank"><i class="fas fa-eye"></i> View</a></td>
        </tr>`).join('')}
      </tbody></table>`;
    }

    function getDefaultRange() {
      const now = new Date(); const start = new Date(now.getTime() - 27*24*60*60*1000);
      const iso = (d)=>d.toISOString().slice(0,10);
      return { start: iso(start), end: iso(now) };
    }

    async function initPropertyPage() {
      const site = qs('site');
      if (!site) { document.getElementById('err').textContent = 'Missing site parameter'; return; }
      document.getElementById('siteLabel').textContent = site;
      await ensureSelectedProperty(site);

      // New Audit form
      const auditUrlEl = document.getElementById('auditUrl');
      const auditTypeEl = document.getElementById('auditType');
      const runBtn = document.getElementById('runAuditBtn');
      const auditMsg = document.getElementById('auditMsg');
      const defaultUrl = deriveAuditUrl(site);
      if (auditUrlEl) auditUrlEl.value = defaultUrl;
      if (runBtn) runBtn.addEventListener('click', async () => {
        const url = (auditUrlEl.value || '').trim();
        const sType = auditTypeEl.value;
        auditMsg.textContent = '';
        if (!/^https?:\/\//i.test(url)) { auditMsg.textContent = 'Please enter a valid URL (including http/https).'; return; }
        const original = runBtn.innerHTML; runBtn.disabled = true; runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
        try {
          const resp = await fetch('/api/audit', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ siteUrl: url, siteType: sType }) });
          const data = await resp.json();
          if (!resp.ok || !data.success) throw new Error(data.message || 'Audit failed');
          auditMsg.style.color = '#155724';
          auditMsg.textContent = 'Audit completed successfully';
          await loadAudits(url);
        } catch (e) {
          auditMsg.style.color = '#c33';
          auditMsg.textContent = e.message;
        } finally { runBtn.disabled = false; runBtn.innerHTML = original; }
      });

      // Controls
      const startEl = document.getElementById('start');
      const endEl = document.getElementById('end');
      const typeEl = document.getElementById('stype');
      const applyBtn = document.getElementById('apply');
      const range = getDefaultRange();
      startEl.value = range.start; endEl.value = range.end;
      const loadAll = async () => {
        await loadKpis({ start: startEl.value, end: endEl.value }, typeEl.value);
        await loadAudits(site);
        // Load insights (current active tab)
        if (window.__insightsLoad) await window.__insightsLoad();
      };
      applyBtn.addEventListener('click', loadAll);
      await loadAll();
    }

    document.addEventListener('DOMContentLoaded', initPropertyPage);
  </script>
</head>
<body>
  <div class="top">
    <div class="h1"><i class="fas fa-globe"></i> Property <span class="muted">—</span> <span id="siteLabel" class="muted"></span></div>
    <div>
      <a href="/dashboard" class="audit-btn" style="background:#6c757d"><i class="fas fa-arrow-left"></i> Dashboard</a>
    </div>
  </div>
  <div class="container">
    <div id="err" class="error"></div>

    <div class="card">
      <h3 style="margin:.25rem 0 1rem 0"><i class="fas fa-play"></i> New Audit</h3>
      <div class="controls">
        <div style="flex:1">
          <label class="muted">URL</label>
          <input type="url" id="auditUrl" placeholder="https://example.com/" style="width:100%;padding:.6rem;border:1px solid #e1e5e9;border-radius:6px">
        </div>
        <div>
          <label class="muted">Site Type</label>
          <select id="auditType" style="padding:.6rem;border:1px solid #e1e5e9;border-radius:6px">
            <option value="Generic" selected>Generic</option>
            <option value="SaaS">SaaS</option>
            <option value="Ecommerce">Ecommerce</option>
            <option value="Agency">Agency</option>
            <option value="Local">Local</option>
          </select>
        </div>
        <button id="runAuditBtn" class="audit-btn"><i class="fas fa-play"></i> Run Audit</button>
      </div>
      <div id="auditMsg" class="muted" style="margin-top:.5rem"></div>
    </div>

    <div class="card">
      <div class="controls">
        <div><label class="muted">Start</label> <input type="date" id="start"></div>
        <div><label class="muted">End</label> <input type="date" id="end"></div>
        <div>
          <label class="muted">Type</label>
          <select id="stype"><option value="web" selected>Web</option><option value="image">Image</option><option value="video">Video</option><option value="news">News</option><option value="discover">Discover</option></select>
        </div>
        <button id="apply" class="audit-btn"><i class="fas fa-check"></i> Apply</button>
      </div>
      <div id="kpis"></div>
    </div>

    <div class="card">
      <h3 style="margin:.25rem 0 1rem 0"><i class="fas fa-history"></i> Recent Audits</h3>
      <div id="audits"></div>
    </div>

    <div class="card">
      <h3 style="margin:.25rem 0 1rem 0"><i class="fas fa-chart-pie"></i> GSC Insights</h3>
      <div class="controls">
        <div>
          <label class="muted">Rows</label>
          <select id="prow" style="padding:.4rem;border:1px solid #e1e5e9;border-radius:6px">
            <option value="50" selected>50</option>
            <option value="100">100</option>
            <option value="500">500</option>
          </select>
        </div>
        <button id="pPages"   class="audit-btn"><i class="fas fa-file-alt"></i> Pages</button>
        <button id="pQueries" class="audit-btn" style="background:#6c757d"><i class="fas fa-search"></i> Queries</button>
        <button id="pDevice"  class="audit-btn" style="background:#6c757d"><i class="fas fa-mobile-alt"></i> Device</button>
        <button id="pCountry" class="audit-btn" style="background:#6c757d"><i class="fas fa-globe"></i> Country</button>
        <button id="pAppear"  class="audit-btn" style="background:#6c757d"><i class="fas fa-star"></i> Appearance</button>
      </div>
      <div id="pInsights"></div>
      <div id="pPager" style="margin-top:.5rem; display:flex; gap:.5rem; align-items:center"></div>
    </div>
  </div>

  <script>
    // Insights logic for property page
    (function(){
      const byId = (id) => document.getElementById(id);
      const startEl = byId('start');
      const endEl = byId('end');
      const typeEl = byId('stype');
      const rowsEl = byId('prow');
      const out = byId('pInsights');
      const pager = byId('pPager');
      const btns = {
        pages: byId('pPages'),
        queries: byId('pQueries'),
        device: byId('pDevice'),
        country: byId('pCountry'),
        appearance: byId('pAppear')
      };
      let endpoint = '/api/gsc/analytics/pages';
      let tab = 'pages';
      let rowLimit = 50;
      let startRow = 0;

      const setActive = (key) => {
        Object.entries(btns).forEach(([k, b]) => { if (b) b.style.background = (k===key? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#6c757d'); });
      };

      const buildUrl = () => {
        const params = new URLSearchParams();
        params.append('startDate', startEl.value);
        params.append('endDate', endEl.value);
        params.append('searchType', typeEl.value);
        params.append('rowLimit', String(rowLimit));
        params.append('startRow', String(startRow));
        return `${endpoint}?${params.toString()}`;
      };

      const render = (rows) => {
        if (!rows || rows.length === 0) { out.innerHTML = '<p class="muted">No data for selected range.</p>'; pager.innerHTML=''; return; }
        const label = tab==='pages'?'Page':tab==='queries'?'Query':tab==='device'?'Device':tab==='country'?'Country':'Appearance';
        const firstVal = (r)=> tab==='pages'?r.page: tab==='queries'?r.query: tab==='device'?r.device: tab==='country'?r.country: r.appearance;
        out.innerHTML = `<table class="history-table"><thead><tr><th>${label}</th><th>Clicks</th><th>Impr</th><th>CTR</th><th>Pos</th></tr></thead><tbody>
          ${rows.map(r=>`<tr><td>${firstVal(r)||''}</td><td>${(r.clicks||0).toLocaleString()}</td><td>${(r.impressions||0).toLocaleString()}</td><td>${(((r.ctr||0)*100)||0).toFixed(2)}%</td><td>${((r.position||0)||0).toFixed(1)}</td></tr>`).join('')}
        </tbody></table>`;
        pager.innerHTML = `
          <button id="pgPrev2" class="audit-btn" style="width:auto;background:#6c757d" ${startRow===0?'disabled':''}><i class="fas fa-chevron-left"></i> Prev</button>
          <span class="muted">Rows ${startRow+1}–${startRow+rows.length}</span>
          <button id="pgNext2" class="audit-btn" style="width:auto"><i class="fas fa-chevron-right"></i> Next</button>`;
        const prev = byId('pgPrev2'); const next = byId('pgNext2');
        if (prev) prev.onclick = ()=>{ if (startRow>0){ startRow=Math.max(0,startRow-rowLimit); load(); }};
        if (next) next.onclick = ()=>{ startRow += rowLimit; load(); };
      };

      async function load(){
        out.innerHTML = '<p class="muted"><i class="fas fa-spinner fa-spin"></i> Loading…</p>';
        try {
          const r = await fetch(buildUrl(), { credentials:'include' });
          const d = await r.json();
          if (!r.ok || !d.success) throw new Error(d.message||'Failed to load');
          render(d.data);
        } catch(e){ out.innerHTML = `<p class="error">${e.message}</p>`; pager.innerHTML=''; }
      }

      // public hook so the top Apply button can reload current tab
      window.__insightsLoad = load;

      if (rowsEl) rowsEl.onchange = ()=>{ rowLimit=parseInt(rowsEl.value||'50',10); startRow=0; load(); };
      if (btns.pages) btns.pages.onclick = ()=>{ endpoint='/api/gsc/analytics/pages'; tab='pages'; setActive('pages'); startRow=0; load(); };
      if (btns.queries) btns.queries.onclick = ()=>{ endpoint='/api/gsc/analytics/queries'; tab='queries'; setActive('queries'); startRow=0; load(); };
      if (btns.device) btns.device.onclick = ()=>{ endpoint='/api/gsc/analytics/device'; tab='device'; setActive('device'); startRow=0; load(); };
      if (btns.country) btns.country.onclick = ()=>{ endpoint='/api/gsc/analytics/country'; tab='country'; setActive('country'); startRow=0; load(); };
      if (btns.appearance) btns.appearance.onclick = ()=>{ endpoint='/api/gsc/analytics/appearance'; tab='appearance'; setActive('appearance'); startRow=0; load(); };

      // default
      setActive('pages'); load();
    })();
  </script>
</body>
</html>


